<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>修仙放置游戏 - 完整版</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
        }

        .game-container {
            display: grid;
            grid-template-columns: 350px 1fr 300px;
            grid-template-rows: 60px 1fr;
            height: 100vh;
            gap: 10px;
            padding: 10px;
        }

        .header {
            grid-column: 1 / -1;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .game-title {
            font-size: 24px;
            font-weight: bold;
            color: #4a5568;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .online-status {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 14px;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #48bb78;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .save-load {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            font-size: 14px;
            position: relative;
            overflow: hidden;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: linear-gradient(135deg, #4299e1, #63b3ed);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #48bb78, #68d391);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #f56565, #fc8181);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ed8936, #f6ad55);
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .character-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
        }

        .main-area {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
        }

        .sidebar {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
        }

        .section-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #2d3748;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .character-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .info-item {
            background: linear-gradient(135deg, #f7fafc, #edf2f7);
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid #4299e1;
            transition: all 0.3s ease;
        }

        .info-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .info-label {
            font-size: 12px;
            color: #718096;
            margin-bottom: 3px;
            font-weight: 500;
        }

        .info-value {
            font-size: 16px;
            font-weight: bold;
            color: #2d3748;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4299e1, #63b3ed);
            transition: width 0.5s ease;
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .actions-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab-container {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid #e2e8f0;
            margin-bottom: 20px;
            overflow-x: auto;
        }

        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border: none;
            background: transparent;
            font-size: 14px;
            font-weight: 500;
            color: #718096;
            transition: all 0.3s ease;
            white-space: nowrap;
            position: relative;
        }

        .tab:hover {
            color: #4299e1;
            background: rgba(66, 153, 225, 0.1);
        }

        .tab.active {
            color: #4299e1;
            border-bottom: 2px solid #4299e1;
            background: rgba(66, 153, 225, 0.1);
        }

        .tab-content {
            display: none;
            flex: 1;
            overflow-y: auto;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-log {
            background: #1a202c;
            color: #e2e8f0;
            border: 1px solid #2d3748;
            border-radius: 8px;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Consolas', monospace;
            font-size: 12px;
            line-height: 1.6;
        }

        .message-log::-webkit-scrollbar {
            width: 6px;
        }

        .message-log::-webkit-scrollbar-track {
            background: #2d3748;
        }

        .message-log::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 3px;
        }

        .log-message {
            margin-bottom: 2px;
            opacity: 0;
            animation: messageSlide 0.3s ease forwards;
        }

        @keyframes messageSlide {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .log-message.system { color: #48bb78; }
        .log-message.battle { color: #f56565; }
        .log-message.level { color: #ed8936; }
        .log-message.quest { color: #9f7aea; }

        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .inventory-slot {
            aspect-ratio: 1;
            background: linear-gradient(135deg, #f7fafc, #edf2f7);
            border: 2px dashed #e2e8f0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .inventory-slot.occupied {
            background: linear-gradient(135deg, #e6fffa, #b2f5ea);
            border-color: #38b2ac;
            border-style: solid;
        }

        .inventory-slot:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .item-icon {
            font-size: 28px;
        }

        .item-count {
            position: absolute;
            bottom: 2px;
            right: 2px;
            background: linear-gradient(135deg, #4299e1, #63b3ed);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .battle-arena {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            margin-bottom: 20px;
            align-items: center;
        }

        .character-card {
            background: linear-gradient(135deg, #f7fafc, #edf2f7);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            position: relative;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .character-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
        }

        .character-avatar {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 50%;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            color: white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
        }

        .character-avatar::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: avatarShine 3s infinite;
        }

        @keyframes avatarShine {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .vs-indicator {
            font-size: 48px;
            color: #e53e3e;
            font-weight: bold;
            animation: vsGlow 2s infinite alternate;
        }

        @keyframes vsGlow {
            from { text-shadow: 0 0 5px #e53e3e; }
            to { text-shadow: 0 0 20px #e53e3e, 0 0 30px #e53e3e; }
        }

        .hp-bar {
            width: 100%;
            height: 25px;
            background: #fed7d7;
            border-radius: 12px;
            overflow: hidden;
            margin-top: 15px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .hp-fill {
            height: 100%;
            background: linear-gradient(90deg, #f56565, #fc8181);
            transition: width 0.8s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
            position: relative;
        }

        .skill-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }

        .skill-card {
            background: linear-gradient(135deg, #f7fafc, #edf2f7);
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .skill-card:hover {
            background: linear-gradient(135deg, #edf2f7, #e2e8f0);
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }

        .skill-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .skill-card.disabled:hover {
            transform: none;
        }

        .skill-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: left 0.5s ease;
        }

        .skill-card:hover::before {
            left: 100%;
        }

        .skill-cooldown {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #e53e3e;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .map-container {
            display: flex;
            gap: 20px;
        }

        .map-selection {
            width: 200px;
        }

        .map-area {
            flex: 1;
        }

        .map-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 3px;
            max-width: 500px;
            margin: 0 auto 20px;
            background: #2d3748;
            padding: 10px;
            border-radius: 10px;
        }

        .map-tile {
            aspect-ratio: 1;
            border: 1px solid #4a5568;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
            position: relative;
            background: #1a202c;
        }

        .map-tile.player {
            background: linear-gradient(135deg, #4299e1, #63b3ed);
            color: white;
            box-shadow: 0 0 10px #4299e1;
            animation: playerGlow 2s infinite alternate;
        }

        @keyframes playerGlow {
            from { box-shadow: 0 0 10px #4299e1; }
            to { box-shadow: 0 0 20px #4299e1, 0 0 30px #4299e1; }
        }

        .map-tile.enemy {
            background: linear-gradient(135deg, #f56565, #fc8181);
            color: white;
        }

        .map-tile.treasure {
            background: linear-gradient(135deg, #ed8936, #f6ad55);
            color: white;
            animation: treasureShine 3s infinite;
        }

        @keyframes treasureShine {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .map-tile.town {
            background: linear-gradient(135deg, #48bb78, #68d391);
            color: white;
        }

        .map-tile.boss {
            background: linear-gradient(135deg, #9f7aea, #b794f6);
            color: white;
            animation: bossFlash 1s infinite alternate;
        }

        @keyframes bossFlash {
            from { opacity: 0.8; }
            to { opacity: 1; }
        }

        .map-tile:hover {
            transform: scale(1.1);
            z-index: 1;
        }

        .auto-cultivation {
            background: linear-gradient(135deg, #f7fafc, #edf2f7);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid #e2e8f0;
        }

        .cultivation-timer {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            color: #4299e1;
            margin: 10px 0;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #48bb78, #68d391);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            min-width: 250px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: linear-gradient(135deg, #f56565, #fc8181);
        }

        .notification.warning {
            background: linear-gradient(135deg, #ed8936, #f6ad55);
        }

        .floating-damage {
            position: absolute;
            font-weight: bold;
            font-size: 18px;
            z-index: 100;
            pointer-events: none;
            animation: floatUp 2s ease-out forwards;
        }

        @keyframes floatUp {
            0% {
                opacity: 1;
                transform: translateY(0);
            }
            100% {
                opacity: 0;
                transform: translateY(-50px);
            }
        }

        .achievement-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            z-index: 1001;
            text-align: center;
            min-width: 300px;
            opacity: 0;
            transform: translate(-50%, -50%) scale(0.5);
            transition: all 0.3s ease;
        }

        .achievement-popup.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
        }

        .modal-overlay.show {
            display: block;
        }

        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 1001;
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4299e1;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 特殊效果 */
        .critical-hit {
            color: #e53e3e !important;
            font-size: 24px !important;
            text-shadow: 0 0 10px #e53e3e;
            animation: criticalPulse 0.5s ease;
        }

        @keyframes criticalPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        .level-up-effect {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 32px;
            color: #ed8936;
            font-weight: bold;
            pointer-events: none;
            animation: levelUpBurst 2s ease-out forwards;
            z-index: 100;
        }

        @keyframes levelUpBurst {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.5);
            }
            20% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.2);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(1) translateY(-100px);
            }
        }

        .element-fire { border-left-color: #e53e3e; }
        .element-water { border-left-color: #3182ce; }
        .element-earth { border-left-color: #d69e2e; }
        .element-air { border-left-color: #38b2ac; }
        .element-light { border-left-color: #ecc94b; }
        .element-dark { border-left-color: #805ad5; }

        /* 响应式设计 */
        @media (max-width: 1200px) {
            .game-container {
                grid-template-columns: 300px 1fr 250px;
            }
        }

        @media (max-width: 900px) {
            .game-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto 1fr;
            }
            
            .character-panel,
            .sidebar {
                max-height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="header">
            <div class="game-title">
                🏔️ 修仙放置游戏
                <div class="online-status">
                    <div class="status-indicator"></div>
                    <span>在线修炼中</span>
                    <span id="online-time">00:00:00</span>
                </div>
            </div>
            <div class="save-load">
                <button class="btn btn-warning" onclick="showSettings()">⚙️ 设置</button>
                <button class="btn btn-primary" onclick="saveGame()">💾 保存</button>
                <button class="btn btn-success" onclick="loadGame()">📁 加载</button>
                <button class="btn btn-danger" onclick="resetGame()">🔄 重置</button>
            </div>
        </div>

        <div class="character-panel">
            <h2 class="section-title">
                👤 角色信息
                <span id="power-level" style="font-size: 14px; color: #4299e1;">战力: 0</span>
            </h2>
            
            <!-- 灵根属性 -->
            <div class="info-item element-fire" style="grid-column: 1 / -1; margin-bottom: 10px;">
                <div class="info-label">灵根属性</div>
                <div class="info-value" id="spiritual-root">火灵根 (上品)</div>
            </div>
            
            <div class="character-info">
                <div class="info-item">
                    <div class="info-label">姓名</div>
                    <div class="info-value" id="char-name">修仙者</div>
                </div>
                <div class="info-item">
                    <div class="info-label">境界</div>
                    <div class="info-value" id="char-realm">练气 1层</div>
                </div>
                <div class="info-item">
                    <div class="info-label">修为</div>
                    <div class="info-value" id="char-exp">0</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="exp-progress" style="width: 0%"></div>
                    </div>
                </div>
                <div class="info-item">
                    <div class="info-label">灵石</div>
                    <div class="info-value" id="char-gold">100</div>
                </div>
                <div class="info-item">
                    <div class="info-label">生命值</div>
                    <div class="info-value" id="char-hp">100/100</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="hp-progress" style="width: 100%; background: linear-gradient(90deg, #f56565, #fc8181);"></div>
                    </div>
                </div>
                <div class="info-item">
                    <div class="info-label">法力值</div>
                    <div class="info-value" id="char-mp">10/10</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="mp-progress" style="width: 100%; background: linear-gradient(90deg, #4299e1, #63b3ed);"></div>
                    </div>
                </div>
                <div class="info-item">
                    <div class="info-label">攻击力</div>
                    <div class="info-value" id="char-attack">10</div>
                </div>
                <div class="info-item">
                    <div class="info-label">防御力</div>
                    <div class="info-value" id="char-defense">5</div>
                </div>
                <div class="info-item">
                    <div class="info-label">速度</div>
                    <div class="info-value" id="char-speed">5</div>
                </div>
                <div class="info-item">
                    <div class="info-label">暴击率</div>
                    <div class="info-value" id="char-crit">5%</div>
                </div>
                <div class="info-item">
                    <div class="info-label">运气</div>
                    <div class="info-value" id="char-luck">5</div>
                </div>
                <div class="info-item">
                    <div class="info-label">智慧</div>
                    <div class="info-value" id="char-wisdom">5</div>
                </div>
            </div>

            <!-- 自动修炼面板 -->
            <div class="auto-cultivation">
                <h3 style="text-align: center; margin-bottom: 10px;">🧘 自动修炼</h3>
                <div class="cultivation-timer" id="auto-timer">未开启</div>
                <div class="actions-grid">
                    <button class="btn btn-success" onclick="startAutoCultivation()">开始挂机</button>
                    <button class="btn btn-danger" onclick="stopAutoCultivation()">停止挂机</button>
                </div>
                <div style="font-size: 12px; text-align: center; color: #666; margin-top: 5px;">
                    离线收益: <span id="offline-bonus">0</span> 修为/小时
                </div>
            </div>

            <h3 class="section-title">⚡ 快速操作</h3>
            <div class="actions-grid">
                <button class="btn btn-primary" onclick="cultivate()">🧘 修炼 (1天)</button>
                <button class="btn btn-success" onclick="adventure()">🗺️ 历练</button>
                <button class="btn btn-warning" onclick="breakthrough()">⚡ 尝试突破</button>
                <button class="btn btn-danger" onclick="randomBattle()">⚔️ 随机战斗</button>
            </div>
        </div>

        <div class="main-area">
            <div class="tab-container">
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('home')">🏠 主页</button>
                    <button class="tab" onclick="switchTab('battle')">⚔️ 战斗</button>
                    <button class="tab" onclick="switchTab('skills')">✨ 技能</button>
                    <button class="tab" onclick="switchTab('map')">🗺️ 地图</button>
                    <button class="tab" onclick="switchTab('shop')">🏪 商店</button>
                    <button class="tab" onclick="switchTab('quests')">📋 任务</button>
                    <button class="tab" onclick="switchTab('achievement')">🏆 成就</button>
                    <button class="tab" onclick="switchTab('cultivation')">🧙 修炼</button>
                </div>

                <!-- 主页标签 -->
                <div class="tab-content active" id="home-tab">
                    <h2 class="section-title">📖 游戏日志</h2>
                    <div class="message-log" id="message-log">
                        <div class="log-message system">欢迎来到修仙世界！开始你的修仙之路吧！</div>
                    </div>
                </div>

                <!-- 战斗标签 -->
                <div class="tab-content" id="battle-tab">
                    <h2 class="section-title">⚔️ 战斗竞技场</h2>
                    <div class="battle-arena" id="battle-arena">
                        <div class="character-card" id="player-card">
                            <div class="character-avatar">🧙</div>
                            <h3 id="player-name">修仙者</h3>
                            <div>等级: <span id="player-level">1</span></div>
                            <div class="hp-bar">
                                <div class="hp-fill" id="player-hp-bar" style="width: 100%">100/100</div>
                            </div>
                            <div class="hp-bar" style="margin-top: 5px;">
                                <div class="hp-fill" id="player-mp-bar" style="width: 100%; background: linear-gradient(90deg, #4299e1, #63b3ed);">10/10</div>
                            </div>
                        </div>
                        <div class="vs-indicator">⚔️</div>
                        <div class="character-card" id="enemy-card">
                            <div class="character-avatar">❓</div>
                            <h3 id="enemy-name">选择对手</h3>
                            <div>等级: <span id="enemy-level">--</span></div>
                            <div class="hp-bar">
                                <div class="hp-fill" id="enemy-hp-bar" style="width: 100%">--/--</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <h3>选择对手</h3>
                            <div class="skill-list">
                                <div class="skill-card" onclick="selectEnemy('bandit')">
                                    <h4>🗡️ 练气期强盗</h4>
                                    <p>等级: 2-4</p>
                                    <p>生命值: 80-120</p>
                                    <p>攻击力: 15-25</p>
                                    <div style="color: #48bb78; font-size: 12px;">掉落: 灵石, 装备</div>
                                </div>
                                <div class="skill-card" onclick="selectEnemy('beast')">
                                    <h4>🐺 妖兽</h4>
                                    <p>等级: 3-6</p>
                                    <p>生命值: 150-250</p>
                                    <p>攻击力: 20-35</p>
                                    <div style="color: #48bb78; font-size: 12px;">掉落: 妖核, 材料</div>
                                </div>
                                <div class="skill-card" onclick="selectEnemy('demon')">
                                    <h4>👺 筑基期妖魔</h4>
                                    <p>等级: 10-15</p>
                                    <p>生命值: 400-600</p>
                                    <p>攻击力: 50-80</p>
                                    <div style="color: #e53e3e; font-size: 12px;">危险！需要筑基期实力</div>
                                </div>
                                <div class="skill-card" onclick="selectEnemy('boss')">
                                    <h4>🐉 远古巨龙</h4>
                                    <p>等级: 50</p>
                                    <p>生命值: 10000</p>
                                    <p>攻击力: 500</p>
                                    <div style="color: #9f7aea; font-size: 12px;">传说级BOSS</div>
                                </div>
                            </div>
                        </div>
                        <div>
                            <h3>战斗操作</h3>
                            <div id="battle-actions" style="display: none;">
                                <div class="actions-grid">
                                    <button class="btn btn-danger" onclick="normalAttack()">⚔️ 普通攻击</button>
                                    <button class="btn btn-primary" onclick="showSkillsInBattle()">✨ 使用技能</button>
                                    <button class="btn btn-success" onclick="showItemsInBattle()">🧪 使用物品</button>
                                    <button class="btn btn-warning" onclick="defend()">🛡️ 防御</button>
                                </div>
                                <button class="btn btn-danger" onclick="escapeBattle()" style="width: 100%; margin-top: 10px;">🏃 逃跑</button>
                            </div>
                            <button class="btn btn-success" onclick="startBattle()" id="start-battle-btn" style="width: 100%;">🎯 开始战斗</button>
                        </div>
                    </div>
                </div>

                <!-- 技能标签 -->
                <div class="tab-content" id="skills-tab">
                    <h2 class="section-title">✨ 技能系统</h2>
                    <div class="skill-list" id="skill-display-list">
                        <!-- 技能将通过JavaScript生成 -->
                    </div>
                </div>

                <!-- 地图标签 -->
                <div class="tab-content" id="map-tab">
                    <h2 class="section-title">🗺️ 世界地图</h2>
                    <div class="map-container">
                        <div class="map-selection">
                            <h4>选择地图区域</h4>
                            <div class="skill-list" style="grid-template-columns: 1fr;">
                                <div class="skill-card" onclick="switchMap('newbie')" id="map-newbie">
                                    <h4>🌱 新手村</h4>
                                    <p>等级推荐: 1-10</p>
                                </div>
                                <div class="skill-card" onclick="switchMap('forest')" id="map-forest">
                                    <h4>🌲 迷雾森林</h4>
                                    <p>等级推荐: 5-20</p>
                                </div>
                                <div class="skill-card" onclick="switchMap('mountain')" id="map-mountain">
                                    <h4>⛰️ 云雾山脉</h4>
                                    <p>等级推荐: 15-35</p>
                                </div>
                                <div class="skill-card" onclick="switchMap('ruins')" id="map-ruins">
                                    <h4>🏛️ 上古遗迹</h4>
                                    <p>等级推荐: 30+</p>
                                </div>
                            </div>
                        </div>
                        <div class="map-area">
                            <div style="text-align: center; margin-bottom: 10px;">
                                <h3 id="current-map-name">新手村</h3>
                                <p id="current-map-desc">安全的修炼之地</p>
                            </div>
                            <div class="map-grid" id="map-grid">
                                <!-- 地图将通过JavaScript生成 -->
                            </div>
                            <div style="text-align: center;">
                                <p><strong>图例：</strong></p>
                                <p>🧙 玩家 | 👹 敌人 | 💰 宝藏 | 🏘️ 城镇 | 🐉 BOSS</p>
                                <p>移动消耗: <span id="movement-cost">1</span> 行动点</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 商店标签 -->
                <div class="tab-content" id="shop-tab">
                    <h2 class="section-title">🏪 天材地宝坊</h2>
                    <div class="tabs" style="border-bottom: 1px solid #e2e8f0; margin-bottom: 15px;">
                        <button class="tab active" onclick="switchShopTab('items')">📦 物品</button>
                        <button class="tab" onclick="switchShopTab('equipment')">⚔️ 装备</button>
                        <button class="tab" onclick="switchShopTab('pills')">💊 丹药</button>
                        <button class="tab" onclick="switchShopTab('techniques')">📜 功法</button>
                    </div>
                    <div id="shop-items">
                        <!-- 商店物品将通过JavaScript生成 -->
                    </div>
                </div>

                <!-- 任务标签 -->
                <div class="tab-content" id="quests-tab">
                    <h2 class="section-title">📋 仙门任务</h2>
                    <div id="quest-list">
                        <!-- 任务列表将通过JavaScript生成 -->
                    </div>
                </div>

                <!-- 成就标签 -->
                <div class="tab-content" id="achievement-tab">
                    <h2 class="section-title">🏆 修仙成就</h2>
                    <div id="achievement-list">
                        <!-- 成就列表将通过JavaScript生成 -->
                    </div>
                </div>

                <!-- 修炼标签 -->
                <div class="tab-content" id="cultivation-tab">
                    <h2 class="section-title">🧙 修炼系统</h2>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <h3>功法修炼</h3>
                            <div id="technique-list">
                                <!-- 功法列表 -->
                            </div>
                        </div>
                        <div>
                            <h3>境界突破</h3>
                            <div class="info-item">
                                <div class="info-label">当前境界</div>
                                <div class="info-value" id="breakthrough-current">练气 1层</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">突破成功率</div>
                                <div class="info-value" id="breakthrough-chance">95%</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">所需修为</div>
                                <div class="info-value" id="breakthrough-cost">100</div>
                            </div>
                            <button class="btn btn-warning" onclick="attemptBreakthrough()" style="width: 100%; margin-top: 10px;">⚡ 开始突破</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 侧边栏 -->
        <div class="sidebar">
            <h2 class="section-title">🎒 背包物品</h2>
            <div class="inventory-grid" id="inventory">
                <!-- 背包物品将通过JavaScript生成 -->
            </div>

            <h2 class="section-title" style="margin-top: 20px;">⚔️ 装备栏</h2>
            <div id="equipment-slots">
                <div class="info-item">
                    <div class="info-label">武器</div>
                    <div class="info-value" id="weapon-slot">无</div>
                </div>
                <div class="info-item">
                    <div class="info-label">护甲</div>
                    <div class="info-value" id="armor-slot">无</div>
                </div>
                <div class="info-item">
                    <div class="info-label">饰品</div>
                    <div class="info-value" id="accessory-slot">无</div>
                </div>
                <div class="info-item">
                    <div class="info-label">功法</div>
                    <div class="info-value" id="technique-slot">基础吐纳术</div>
                </div>
            </div>

            <h2 class="section-title" style="margin-top: 20px;">📊 统计数据</h2>
            <div id="statistics">
                <div class="info-item">
                    <div class="info-label">修炼天数</div>
                    <div class="info-value" id="days-count">1</div>
                </div>
                <div class="info-item">
                    <div class="info-label">战斗胜利</div>
                    <div class="info-value" id="battles-won">0</div>
                </div>
                <div class="info-item">
                    <div class="info-label">击败敌人</div>
                    <div class="info-value" id="enemies-defeated">0</div>
                </div>
                <div class="info-item">
                    <div class="info-label">完成任务</div>
                    <div class="info-value" id="quests-completed">0</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 模态框 -->
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal" id="modal-content">
            <!-- 模态框内容将通过JavaScript动态生成 -->
        </div>
    </div>

    <script>
        // 游戏数据
        let gameData = {
            character: {
                name: "修仙者",
                level: 1,
                realmIndex: 0,
                exp: 0,
                gold: 100,
                day: 1,
                hp: 100,
                maxHp: 100,
                mp: 10,
                maxMp: 10,
                attack: 10,
                defense: 5,
                speed: 5,
                luck: 5,
                wisdom: 5,
                charisma: 5,
                critRate: 5,
                spiritualRoot: { type: 'fire', quality: 'high' },
                techniques: ['基础吐纳术'],
                skills: [
                    { name: '普通攻击', level: 1, cooldown: 0, maxCooldown: 0, cost: 0, type: 'physical' },
                    { name: '火球术', level: 1, cooldown: 0, maxCooldown: 2, cost: 10, type: 'fire', unlocked: false }
                ],
                inventory: {
                    '治疗药水': 3,
                    '法力药水': 2
                },
                equipment: {
                    weapon: null,
                    armor: null,
                    accessory: null,
                    technique: '基础吐纳术'
                },
                position: { x: 4, y: 4, map: 'newbie' },
                actionPoints: 10,
                maxActionPoints: 10
            },
            battle: {
                inBattle: false,
                enemy: null,
                playerTurn: true,
                round: 0,
                playerDefending: false,
                enemyDefending: false
            },
            maps: {
                newbie: { name: '新手村', desc: '安全的修炼之地', size: 8, level: [1, 10] },
                forest: { name: '迷雾森林', desc: '充满危险的神秘之地', size: 8, level: [5, 20] },
                mountain: { name: '云雾山脉', desc: '高级修士的试炼场', size: 8, level: [15, 35] },
                ruins: { name: '上古遗迹', desc: '传说中的远古战场', size: 8, level: [30, 50] }
            },
            currentMap: 'newbie',
            quests: [
                {
                    id: 1,
                    name: "初心者的修炼",
                    description: "修炼10天，感受灵气的流动",
                    progress: 0,
                    target: 10,
                    reward: { gold: 50, exp: 100 },
                    completed: false,
                    type: 'cultivation'
                },
                {
                    id: 2,
                    name: "战胜强盗",
                    description: "击败5个强盗，证明你的实力",
                    progress: 0,
                    target: 5,
                    reward: { gold: 100, item: '青龙剑' },
                    completed: false,
                    type: 'battle'
                },
                {
                    id: 3,
                    name: "探索者",
                    description: "探索50个地图格子",
                    progress: 0,
                    target: 50,
                    reward: { gold: 200, exp: 300 },
                    completed: false,
                    type: 'exploration'
                }
            ],
            achievements: [
                {
                    id: 1,
                    name: "修仙入门",
                    description: "达到练气3层",
                    condition: { type: 'level', value: 3 },
                    reward: { gold: 100 },
                    unlocked: false
                },
                {
                    id: 2,
                    name: "战斗专家",
                    description: "胜利10场战斗",
                    condition: { type: 'battles_won', value: 10 },
                    reward: { gold: 200 },
                    unlocked: false
                },
                {
                    id: 3,
                    name: "财富积累者",
                    description: "拥有1000灵石",
                    condition: { type: 'gold', value: 1000 },
                    reward: { exp: 500 },
                    unlocked: false
                }
            ],
            statistics: {
                battlesWon: 0,
                enemiesDefeated: 0,
                questsCompleted: 0,
                totalDamageDealt: 0,
                totalDamageTaken: 0
            },
            auto: {
                cultivation: false,
                startTime: null,
                offlineBonus: 10
            },
            settings: {
                autoSave: true,
                soundEnabled: true,
                animationsEnabled: true
            }
        };

        // 游戏常量
        const CULTIVATION_REALMS = [
            "练气", "筑基", "金丹", "元婴", "化神", 
            "炼虚", "合体", "大乘", "渡劫", "飞升"
        ];

        const CULTIVATION_LEVELS = {
            "练气": [100, 200, 300, 400, 500, 600, 700, 800, 900],
            "筑基": [500, 800, 1200, 1600, 2000, 2500, 3000, 3500, 4000],
            "金丹": [1000, 2000, 3000, 4500, 6000, 8000, 10000, 12000, 15000],
            "元婴": [3000, 6000, 10000, 15000, 22000, 30000, 40000, 52000, 66000],
            "化神": [8000, 16000, 26000, 38000, 52000, 70000, 90000, 115000, 145000],
            "炼虚": [20000, 40000, 65000, 95000, 130000, 175000, 225000, 285000, 355000],
            "合体": [50000, 100000, 160000, 230000, 315000, 415000, 535000, 675000, 840000],
            "大乘": [120000, 240000, 385000, 555000, 755000, 985000, 1250000, 1555000, 1905000],
            "渡劫": [300000, 600000, 960000, 1380000, 1865000, 2415000, 3035000, 3725000, 4490000],
            "飞升": [750000, 1500000, 2400000, 3450000, 4650000, 6000000, 7500000, 9150000, 10950000]
        };

        const REALM_UPGRADES = {
            "练气": {hp: 15, attack: 3, defense: 2, mp: 5, speed: 2, luck: 2, wisdom: 2, charisma: 2, critRate: 1},
            "筑基": {hp: 40, attack: 8, defense: 5, mp: 15, speed: 5, luck: 3, wisdom: 3, charisma: 3, critRate: 2},
            "金丹": {hp: 100, attack: 20, defense: 10, mp: 40, speed: 10, luck: 5, wisdom: 5, charisma: 5, critRate: 3},
            "元婴": {hp: 250, attack: 50, defense: 25, mp: 100, speed: 20, luck: 8, wisdom: 8, charisma: 8, critRate: 5},
            "化神": {hp: 600, attack: 120, defense: 60, mp: 250, speed: 40, luck: 12, wisdom: 12, charisma: 12, critRate: 8},
            "炼虚": {hp: 1500, attack: 300, defense: 150, mp: 600, speed: 80, luck: 20, wisdom: 20, charisma: 20, critRate: 12},
            "合体": {hp: 3500, attack: 700, defense: 350, mp: 1400, speed: 150, luck: 30, wisdom: 30, charisma: 30, critRate: 18},
            "大乘": {hp: 8000, attack: 1600, defense: 800, mp: 3200, speed: 250, luck: 45, wisdom: 45, charisma: 45, critRate: 25},
            "渡劫": {hp: 18000, attack: 3600, defense: 1800, mp: 7200, speed: 400, luck: 65, wisdom: 65, charisma: 65, critRate: 35},
            "飞升": {hp: 40000, attack: 8000, defense: 4000, mp: 16000, speed: 600, luck: 90, wisdom: 90, charisma: 90, critRate: 50}
        };

        // 技能数据
        const SKILL_DATA = {
            '普通攻击': {
                description: '基础物理攻击',
                cost: 0,
                cooldown: 0,
                effect: 'damage',
                power: 1.0,
                element: 'physical'
            },
            '火球术': {
                description: '发射火球造成火属性伤害',
                cost: 10,
                cooldown: 2,
                effect: 'damage',
                power: 1.5,
                element: 'fire',
                unlockLevel: 3
            },
            '治疗术': {
                description: '恢复自身生命值',
                cost: 15,
                cooldown: 3,
                effect: 'heal',
                power: 0.3,
                element: 'light',
                unlockLevel: 5
            },
            '雷击术': {
                description: '召唤雷电攻击敌人',
                cost: 25,
                cooldown: 4,
                effect: 'damage',
                power: 2.0,
                element: 'thunder',
                unlockLevel: 8
            },
            '剑气斩': {
                description: '凝聚剑气远程攻击',
                cost: 20,
                cooldown: 3,
                effect: 'damage',
                power: 1.8,
                element: 'sword',
                unlockLevel: 10
            },
            '金钟罩': {
                description: '提升防御力',
                cost: 30,
                cooldown: 5,
                effect: 'buff_defense',
                power: 2.0,
                element: 'earth',
                unlockLevel: 12
            }
        };

        // 商店物品
        const SHOP_ITEMS = {
            items: {
                '治疗药水': { price: 20, description: '恢复50点生命值', icon: '🧪', type: 'consumable' },
                '法力药水': { price: 15, description: '恢复30点法力值', icon: '💙', type: 'consumable' },
                '聚气丹': { price: 100, description: '永久增加10点法力上限', icon: '💊', type: 'permanent' },
                '强身丹': { price: 150, description: '永久增加20点生命上限', icon: '❤️', type: 'permanent' },
                '悟道茶': { price: 200, description: '获得200点修为', icon: '🍵', type: 'consumable' }
            },
            equipment: {
                '青龙剑': { price: 500, description: '攻击力+20的神器', icon: '⚔️', type: 'weapon', stats: {attack: 20} },
                '玄铁甲': { price: 400, description: '防御力+15的护甲', icon: '🛡️', type: 'armor', stats: {defense: 15} },
                '灵玉佩': { price: 300, description: '法力+15的饰品', icon: '💎', type: 'accessory', stats: {mp: 15} },
                '烈焰剑': { price: 1000, description: '火属性神剑，攻击+35', icon: '🔥', type: 'weapon', stats: {attack: 35}, element: 'fire' },
                '龙鳞甲': { price: 800, description: '传说护甲，防御+25', icon: '🐉', type: 'armor', stats: {defense: 25, hp: 50} }
            },
            pills: {
                '筑基丹': { price: 1000, description: '辅助突破筑基境界', icon: '🔮', type: 'breakthrough' },
                '洗髓丹': { price: 2000, description: '改善灵根资质', icon: '✨', type: 'enhancement' },
                '回春丹': { price: 500, description: '完全恢复生命和法力', icon: '🌸', type: 'consumable' }
            },
            techniques: {
                '烈火诀': { price: 800, description: '火属性功法，提升火系技能威力', icon: '🔥', type: 'technique', element: 'fire' },
                '玄水诀': { price: 800, description: '水属性功法，提升防御和恢复', icon: '🌊', type: 'technique', element: 'water' },
                '厚土诀': { price: 800, description: '土属性功法，大幅提升生命值', icon: '🏔️', type: 'technique', element: 'earth' }
            }
        };

        // 敌人数据
        const ENEMIES = {
            bandit: { 
                name: '练气期强盗', 
                hp: 80, 
                attack: 15, 
                defense: 5, 
                level: 3,
                icon: '🗡️', 
                reward: { gold: 30, exp: 50 },
                skills: ['普通攻击']
            },
            beast: { 
                name: '妖兽', 
                hp: 150, 
                attack: 25, 
                defense: 8, 
                level: 5,
                icon: '🐺', 
                reward: { gold: 50, exp: 80 },
                skills: ['普通攻击', '撕咬']
            },
            demon: { 
                name: '筑基期妖魔', 
                hp: 400, 
                attack: 60, 
                defense: 20, 
                level: 12,
                icon: '👺', 
                reward: { gold: 100, exp: 200 },
                skills: ['普通攻击', '魔焰术', '魔气护体']
            },
            boss: { 
                name: '远古巨龙', 
                hp: 10000, 
                attack: 500, 
                defense: 200, 
                level: 50,
                icon: '🐉', 
                reward: { gold: 5000, exp: 10000 },
                skills: ['普通攻击', '龙息', '龙鳞护体', '怒吼']
            }
        };

        // 游戏状态
        let onlineTime = 0;
        let autoCultivationTimer = null;
        let currentEnemy = null;
        let currentShopTab = 'items';

        // 初始化游戏
        function initGame() {
            updateAllDisplays();
            generateMap();
            updateOnlineTime();
            checkOfflineProgress();
            
            // 每秒更新在线时间
            setInterval(updateOnlineTime, 1000);
            
            // 自动保存
            if (gameData.settings.autoSave) {
                setInterval(saveGame, 60000); // 每分钟自动保存
            }
        }

        // 更新所有显示
        function updateAllDisplays() {
            updateCharacterDisplay();
            updateInventory();
            updateSkillList();
            updateEquipment();
            updateQuests();
            updateAchievements();
            updateStatistics();
            updateShop();
            updateBattleDisplay();
        }

        // 更新角色显示
        function updateCharacterDisplay() {
            const char = gameData.character;
            const realm = CULTIVATION_REALMS[char.realmIndex];
            
            document.getElementById('char-name').textContent = char.name;
            document.getElementById('char-realm').textContent = `${realm} ${char.level}层`;
            document.getElementById('char-exp').textContent = char.exp.toLocaleString();
            document.getElementById('char-gold').textContent = char.gold.toLocaleString();
            document.getElementById('char-hp').textContent = `${char.hp}/${char.maxHp}`;
            document.getElementById('char-mp').textContent = `${char.mp}/${char.maxMp}`;
            document.getElementById('char-attack').textContent = char.attack;
            document.getElementById('char-defense').textContent = char.defense;
            document.getElementById('char-speed').textContent = char.speed;
            document.getElementById('char-crit').textContent = char.critRate + '%';
            document.getElementById('char-luck').textContent = char.luck;
            document.getElementById('char-wisdom').textContent = char.wisdom;

            // 计算战力
            const powerLevel = char.attack + char.defense + char.maxHp/10 + char.maxMp/5 + char.speed;
            document.getElementById('power-level').textContent = `战力: ${Math.floor(powerLevel)}`;

            // 更新灵根显示
            const rootTypes = { fire: '火', water: '水', earth: '土', air: '风', light: '光', dark: '暗' };
            const rootQualities = { low: '下品', medium: '中品', high: '上品', perfect: '极品' };
            document.getElementById('spiritual-root').textContent = 
                `${rootTypes[char.spiritualRoot.type]}灵根 (${rootQualities[char.spiritualRoot.quality]})`;

            // 更新进度条
            const expNeeded = char.level <= 9 ? CULTIVATION_LEVELS[realm][char.level - 1] : 0;
            const expProgress = expNeeded > 0 ? (char.exp / expNeeded) * 100 : 100;
            document.getElementById('exp-progress').style.width = Math.min(expProgress, 100) + '%';
            
            const hpProgress = (char.hp / char.maxHp) * 100;
            document.getElementById('hp-progress').style.width = hpProgress + '%';
            
            const mpProgress = (char.mp / char.maxMp) * 100;
            document.getElementById('mp-progress').style.width = mpProgress + '%';

            // 更新修炼相关显示
            document.getElementById('breakthrough-current').textContent = `${realm} ${char.level}层`;
            document.getElementById('breakthrough-cost').textContent = expNeeded.toLocaleString();
            
            // 计算突破成功率
            let successRate = 95 - (char.level - 1) * 5;
            if (char.level === 9) successRate = 70; // 大境界突破更难
            document.getElementById('breakthrough-chance').textContent = Math.max(successRate, 20) + '%';

            // 更新离线收益
            document.getElementById('offline-bonus').textContent = gameData.auto.offlineBonus;
        }

        // 在线时间更新
        function updateOnlineTime() {
            onlineTime++;
            const hours = Math.floor(onlineTime / 3600);
            const minutes = Math.floor((onlineTime % 3600) / 60);
            const seconds = onlineTime % 60;
            document.getElementById('online-time').textContent = 
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // 自动修炼收益
            if (gameData.auto.cultivation && onlineTime % 10 === 0) { // 每10秒获得收益
                const expGain = Math.floor(gameData.auto.offlineBonus / 360); // 每小时收益除以360
                gameData.character.exp += expGain;
                if (expGain > 0) {
                    addMessage(`自动修炼获得 ${expGain} 修为`, 'system');
                    checkLevelUp();
                    updateCharacterDisplay();
                }
            }
        }

        // 检查离线进度
        function checkOfflineProgress() {
            const lastSaveTime = localStorage.getItem('cultivationGameLastSave');
            if (lastSaveTime && gameData.auto.cultivation) {
                const offlineTime = Math.floor((Date.now() - parseInt(lastSaveTime)) / 1000);
                if (offlineTime > 60) { // 离线超过1分钟
                    const offlineHours = offlineTime / 3600;
                    const offlineExp = Math.floor(offlineHours * gameData.auto.offlineBonus);
                    const offlineGold = Math.floor(offlineHours * 5);
                    
                    gameData.character.exp += offlineExp;
                    gameData.character.gold += offlineGold;
                    
                    showModal('离线收益', `
                        <p>离线时间: ${Math.floor(offlineHours)}小时${Math.floor((offlineTime % 3600) / 60)}分钟</p>
                        <p>获得修为: ${offlineExp.toLocaleString()}</p>
                        <p>获得灵石: ${offlineGold.toLocaleString()}</p>
                    `);
                    
                    checkLevelUp();
                }
            }
        }

        // 切换标签页
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
        }

        // 切换商店标签
        function switchShopTab(tabName) {
            currentShopTab = tabName;
            updateShop();
            
            // 更新商店标签样式
            document.querySelectorAll('#shop-tab .tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        // 添加消息到日志
        function addMessage(message, type = 'system') {
            const messageLog = document.getElementById('message-log');
            const messageDiv = document.createElement('div');
            messageDiv.className = `log-message ${type}`;
            
            const timestamp = new Date().toLocaleTimeString();
            messageDiv.innerHTML = `<span style="color: #666;">[${timestamp}]</span> ${message}`;
            
            messageLog.appendChild(messageDiv);
            messageLog.scrollTop = messageLog.scrollHeight;
            
            // 限制消息数量
            while (messageLog.children.length > 100) {
                messageLog.removeChild(messageLog.firstChild);
            }
        }

        // 显示通知
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // 显示模态框
        function showModal(title, content, buttons = []) {
            const overlay = document.getElementById('modal-overlay');
            const modal = document.getElementById('modal-content');
            
            let buttonHtml = '';
            if (buttons.length === 0) {
                buttonHtml = '<button class="btn btn-primary" onclick="closeModal()">确定</button>';
            } else {
                buttonHtml = buttons.map(btn => 
                    `<button class="btn ${btn.class}" onclick="${btn.onclick}">${btn.text}</button>`
                ).join('');
            }
            
            modal.innerHTML = `
                <h2>${title}</h2>
                <div style="margin: 20px 0;">${content}</div>
                <div style="text-align: right; gap: 10px; display: flex; justify-content: flex-end;">
                    ${buttonHtml}
                </div>
            `;
            
            overlay.classList.add('show');
        }

        // 关闭模态框
        function closeModal() {
            document.getElementById('modal-overlay').classList.remove('show');
        }

        // 修炼功能
        function cultivate() {
            const char = gameData.character;
            const baseExp = 15 + char.level * 2;
            const expGain = Math.floor(baseExp * (0.8 + Math.random() * 0.4)); // 80%-120%变动
            
            char.exp += expGain;
            char.day += 1;
            
            // 恢复少量生命值和法力值
            char.hp = Math.min(char.maxHp, char.hp + Math.floor(char.maxHp * 0.05));
            char.mp = Math.min(char.maxMp, char.mp + Math.floor(char.maxMp * 0.1));
            
            addMessage(`修炼获得 ${expGain} 点修为`, 'system');
            checkLevelUp();
            updateCharacterDisplay();
            updateQuestProgress('初心者的修炼', 1);
            
            // 更新统计
            gameData.statistics.totalDamageDealt += expGain;
        }

        // 自动修炼相关
        function startAutoCultivation() {
            gameData.auto.cultivation = true;
            gameData.auto.startTime = Date.now();
            showNotification('开始自动修炼！离线也会获得收益', 'success');
            updateAutoTimer();
        }

        function stopAutoCultivation() {
            gameData.auto.cultivation = false;
            gameData.auto.startTime = null;
            showNotification('停止自动修炼', 'warning');
            updateAutoTimer();
        }

        function updateAutoTimer() {
            const timerElement = document.getElementById('auto-timer');
            if (gameData.auto.cultivation) {
                const startTime = gameData.auto.startTime || Date.now();
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const hours = Math.floor(elapsed / 3600);
                const minutes = Math.floor((elapsed % 3600) / 60);
                const seconds = elapsed % 60;
                timerElement.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                timerElement.style.color = '#48bb78';
                setTimeout(updateAutoTimer, 1000);
            } else {
                timerElement.textContent = '未开启';
                timerElement.style.color = '#718096';
            }
        }

        // 历练功能
        function adventure() {
            const char = gameData.character;
            const goldGain = Math.floor((10 + char.level * 2) * (0.8 + Math.random() * 0.4));
            char.gold += goldGain;
            char.day += 1;
            
            // 随机事件
            const events = [
                { text: "发现了一个古老的洞穴", bonus: 'exp', value: 20 },
                { text: "遇到了友善的商人", bonus: 'gold', value: 20 },
                { text: "找到了遗失的宝箱", bonus: 'item', value: '治疗药水' },
                { text: "击败了路边的盗贼", bonus: 'exp', value: 30 },
                { text: "帮助了迷路的村民", bonus: 'gold', value: 15 }
            ];
            
            const event = events[Math.floor(Math.random() * events.length)];
            let bonusText = '';
            
            if (event.bonus === 'exp') {
                char.exp += event.value;
                bonusText = `，额外获得 ${event.value} 修为`;
            } else if (event.bonus === 'gold') {
                char.gold += event.value;
                bonusText = `，额外获得 ${event.value} 灵石`;
            } else if (event.bonus === 'item') {
                char.inventory[event.value] = (char.inventory[event.value] || 0) + 1;
                bonusText = `，获得 ${event.value} x1`;
            }
            
            addMessage(`历练中${event.text}，获得 ${goldGain} 灵石${bonusText}`, 'system');
            updateCharacterDisplay();
            updateInventory();
            updateQuestProgress('探索者', 1);
        }

        // 突破功能
        function breakthrough() {
            attemptBreakthrough();
        }

        function attemptBreakthrough() {
            const char = gameData.character;
            const realm = CULTIVATION_REALMS[char.realmIndex];
            const expNeeded = char.level <= 9 ? CULTIVATION_LEVELS[realm][char.level - 1] : 0;
            
            if (char.exp < expNeeded) {
                showNotification('修为不足，无法突破！', 'error');
                return;
            }
            
            // 计算成功率
            let successRate = 95 - (char.level - 1) * 5;
            if (char.level === 9) successRate = 70; // 大境界突破更难
            successRate = Math.max(successRate, 20);
            
            const success = Math.random() * 100 < successRate;
            
            if (success) {
                char.exp -= expNeeded;
                char.level += 1;
                applyRealmUpgrade();
                
                showFloatingText(document.getElementById('char-realm'), '突破成功！', '#48bb78');
                addMessage(`成功突破到 ${realm} ${char.level}层！`, 'level');
                
                // 学习新技能
                unlockSkillsAtLevel(char.level);
                
                // 检查大境界突破
                if (char.level > 9 && char.realmIndex < CULTIVATION_REALMS.length - 1) {
                    char.realmIndex += 1;
                    char.level = 1;
                    const newRealm = CULTIVATION_REALMS[char.realmIndex];
                    applyRealmUpgrade();
                    
                    showAchievementPopup(`突破到 ${newRealm} 境界！`, `恭喜！你已经是 ${newRealm} 期修士了！`);
                    addMessage(`🎉 成功突破到 ${newRealm} 境界！实力大幅提升！`, 'level');
                }
                
                updateAllDisplays();
            } else {
                char.exp -= Math.floor(expNeeded * 0.1); // 失败消耗10%修为
                showFloatingText(document.getElementById('char-realm'), '突破失败', '#e53e3e');
                addMessage('突破失败，损失部分修为...', 'system');
                updateCharacterDisplay();
            }
        }

        // 检查升级
        function checkLevelUp() {
            const char = gameData.character;
            const realm = CULTIVATION_REALMS[char.realmIndex];
            
            while (char.level <= 9) {
                const expNeeded = CULTIVATION_LEVELS[realm][char.level - 1];
                if (char.exp >= expNeeded) {
                    char.exp -= expNeeded;
                    char.level += 1;
                    applyRealmUpgrade();
                    
                    showFloatingText(document.getElementById('char-realm'), '升级！', '#ed8936');
                    addMessage(`境界提升到 ${realm} ${char.level}层！`, 'level');
                    
                    // 学习新技能
                    unlockSkillsAtLevel(char.level);
                    
                    // 检查大境界突破
                    if (char.level > 9 && char.realmIndex < CULTIVATION_REALMS.length - 1) {
                        char.realmIndex += 1;
                        char.level = 1;
                        const newRealm = CULTIVATION_REALMS[char.realmIndex];
                        applyRealmUpgrade();
                        
                        showAchievementPopup(`突破到 ${newRealm} 境界！`, `恭喜！你已经是 ${newRealm} 期修士了！`);
                        addMessage(`🎉 成功突破到 ${newRealm} 境界！实力大幅提升！`, 'level');
                        break;
                    }
                } else {
                    break;
                }
            }
            
            updateAllDisplays();
            checkAchievements();
        }

        // 解锁技能
        function unlockSkillsAtLevel(level) {
            const char = gameData.character;
            for (const skill of char.skills) {
                const skillData = SKILL_DATA[skill.name];
                if (skillData && skillData.unlockLevel === level && !skill.unlocked) {
                    skill.unlocked = true;
                    addMessage(`领悟了新技能：${skill.name}！`, 'level');
                    showNotification(`学会新技能：${skill.name}`, 'success');
                }
            }
            
            // 添加新技能
            for (const [skillName, skillData] of Object.entries(SKILL_DATA)) {
                if (skillData.unlockLevel === level && !char.skills.find(s => s.name === skillName)) {
                    char.skills.push({
                        name: skillName,
                        level: 1,
                        cooldown: 0,
                        maxCooldown: skillData.cooldown,
                        cost: skillData.cost,
                        type: skillData.element,
                        unlocked: true
                    });
                    addMessage(`领悟了新技能：${skillName}！`, 'level');
                    showNotification(`学会新技能：${skillName}`, 'success');
                }
            }
        }

        // 应用境界提升
        function applyRealmUpgrade() {
            const char = gameData.character;
            const realm = CULTIVATION_REALMS[char.realmIndex];
            const upgrade = REALM_UPGRADES[realm];
            
            for (const [stat, value] of Object.entries(upgrade)) {
                const randomBonus = Math.floor(value * (0.9 + Math.random() * 0.2)); // 90%-110%
                char[stat] += randomBonus;
                if (stat === 'hp') char.maxHp += randomBonus;
                if (stat === 'mp') char.maxMp += randomBonus;
            }
            
            // 恢复满血满蓝
            char.hp = char.maxHp;
            char.mp = char.maxMp;
        }

        // 更新背包
        function updateInventory() {
            const inventory = document.getElementById('inventory');
            inventory.innerHTML = '';
            
            for (const [itemName, count] of Object.entries(gameData.character.inventory)) {
                if (count > 0) {
                    const slot = document.createElement('div');
                    slot.className = 'inventory-slot occupied';
                    slot.onclick = () => useItem(itemName);
                    
                    const itemData = findItemData(itemName);
                    const icon = itemData?.icon || '📦';
                    slot.innerHTML = `
                        <div class="item-icon">${icon}</div>
                        <div class="item-count">${count}</div>
                    `;
                    slot.title = `${itemName} x${count}\n${itemData?.description || ''}`;
                    inventory.appendChild(slot);
                }
            }
            
            // 添加空槽位
            const totalSlots = 24;
            const usedSlots = Object.keys(gameData.character.inventory).filter(item => gameData.character.inventory[item] > 0).length;
            for (let i = usedSlots; i < totalSlots; i++) {
                const slot = document.createElement('div');
                slot.className = 'inventory-slot';
                inventory.appendChild(slot);
            }
        }

        // 查找物品数据
        function findItemData(itemName) {
            for (const category of Object.values(SHOP_ITEMS)) {
                if (category[itemName]) {
                    return category[itemName];
                }
            }
            return null;
        }

        // 使用物品
        function useItem(itemName) {
            const char = gameData.character;
            if (!char.inventory[itemName] || char.inventory[itemName] <= 0) {
                showNotification('没有这个物品！', 'error');
                return;
            }
            
            const itemData = findItemData(itemName);
            if (!itemData) {
                showNotification('未知物品！', 'error');
                return;
            }
            
            switch(itemName) {
                case '治疗药水':
                    const healAmount = Math.min(50, char.maxHp - char.hp);
                    char.hp += healAmount;
                    char.inventory[itemName] -= 1;
                    addMessage(`使用治疗药水，恢复了 ${healAmount} 点生命值`, 'system');
                    showFloatingText(document.getElementById('char-hp'), `+${healAmount}`, '#48bb78');
                    break;
                    
                case '法力药水':
                    const mpAmount = Math.min(30, char.maxMp - char.mp);
                    char.mp += mpAmount;
                    char.inventory[itemName] -= 1;
                    addMessage(`使用法力药水，恢复了 ${mpAmount} 点法力值`, 'system');
                    showFloatingText(document.getElementById('char-mp'), `+${mpAmount}`, '#4299e1');
                    break;
                    
                case '聚气丹':
                    char.maxMp += 10;
                    char.mp += 10;
                    char.inventory[itemName] -= 1;
                    addMessage(`使用聚气丹，法力上限永久增加10点！`, 'system');
                    break;
                    
                case '强身丹':
                    char.maxHp += 20;
                    char.hp += 20;
                    char.inventory[itemName] -= 1;
                    addMessage(`使用强身丹，生命上限永久增加20点！`, 'system');
                    break;
                    
                case '悟道茶':
                    char.exp += 200;
                    char.inventory[itemName] -= 1;
                    addMessage(`品尝悟道茶，获得200点修为！`, 'system');
                    checkLevelUp();
                    break;
                    
                case '回春丹':
                    char.hp = char.maxHp;
                    char.mp = char.maxMp;
                    char.inventory[itemName] -= 1;
                    addMessage(`使用回春丹，完全恢复生命和法力！`, 'system');
                    break;
                    
                default:
                    // 装备类物品
                    if (itemData.type === 'weapon' || itemData.type === 'armor' || itemData.type === 'accessory') {
                        equipItem(itemName, itemData);
                    }
                    break;
            }
            
            updateCharacterDisplay();
            updateInventory();
        }

        // 装备物品
        function equipItem(itemName, itemData) {
            const char = gameData.character;
            const equipSlot = itemData.type;
            
            // 如果已装备同类型物品，先卸下
            if (char.equipment[equipSlot]) {
                const oldItem = char.equipment[equipSlot];
                char.inventory[oldItem] = (char.inventory[oldItem] || 0) + 1;
                
                // 移除旧装备属性
                const oldItemData = findItemData(oldItem);
                if (oldItemData && oldItemData.stats) {
                    for (const [stat, value] of Object.entries(oldItemData.stats)) {
                        char[stat] -= value;
                        if (stat === 'hp') char.maxHp -= value;
                        if (stat === 'mp') char.maxMp -= value;
                    }
                }
            }
            
            // 装备新物品
            char.equipment[equipSlot] = itemName;
            char.inventory[itemName] -= 1;
            
            // 应用新装备属性
            if (itemData.stats) {
                for (const [stat, value] of Object.entries(itemData.stats)) {
                    char[stat] += value;
                    if (stat === 'hp') char.maxHp += value;
                    if (stat === 'mp') char.maxMp += value;
                }
            }
            
            addMessage(`装备 ${itemName}！`, 'system');
            updateEquipment();
        }

        // 更新技能列表
        function updateSkillList() {
            const skillList = document.getElementById('skill-display-list');
            skillList.innerHTML = '';
            
            gameData.character.skills.forEach(skill => {
                const skillData = SKILL_DATA[skill.name];
                if (!skillData) return;
                
                const skillDiv = document.createElement('div');
                skillDiv.className = `skill-card ${(!skill.unlocked && skill.name !== '普通攻击') ? 'disabled' : ''}`;
                
                if (skill.unlocked || skill.name === '普通攻击') {
                    skillDiv.onclick = () => showSkillDetails(skill);
                }
                
                const cooldownDisplay = skill.cooldown > 0 ? 
                    `<div class="skill-cooldown">${skill.cooldown}</div>` : '';
                
                skillDiv.innerHTML = `
                    ${cooldownDisplay}
                    <h4>✨ ${skill.name} (Lv.${skill.level})</h4>
                    <p>${skillData.description}</p>
                    <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                        <span>消耗: ${skillData.cost} MP</span>
                        <span>冷却: ${skillData.cooldown}回合</span>
                    </div>
                    <div style="color: #666; font-size: 12px; margin-top: 5px;">
                        属性: ${skillData.element} | 威力: ${(skillData.power * 100).toFixed(0)}%
                    </div>
                `;
                skillList.appendChild(skillDiv);
            });
        }

        // 显示技能详情
        function showSkillDetails(skill) {
            const skillData = SKILL_DATA[skill.name];
            showModal(`${skill.name} 详情`, `
                <p><strong>等级:</strong> ${skill.level}</p>
                <p><strong>描述:</strong> ${skillData.description}</p>
                <p><strong>法力消耗:</strong> ${skillData.cost}</p>
                <p><strong>冷却时间:</strong> ${skillData.cooldown} 回合</p>
                <p><strong>属性:</strong> ${skillData.element}</p>
                <p><strong>威力:</strong> ${(skillData.power * 100).toFixed(0)}%</p>
                <hr>
                <p>升级所需: ${skill.level * 100} 灵石</p>
            `, [
                { text: '升级技能', class: 'btn-primary', onclick: `upgradeSkill('${skill.name}')` },
                { text: '关闭', class: 'btn-primary', onclick: 'closeModal()' }
            ]);
        }

        // 升级技能
        function upgradeSkill(skillName) {
            const char = gameData.character;
            const skill = char.skills.find(s => s.name === skillName);
            if (!skill) return;
            
            const cost = skill.level * 100;
            if (char.gold >= cost) {
                char.gold -= cost;
                skill.level += 1;
                addMessage(`${skillName} 升级到 ${skill.level} 级！`, 'system');
                showNotification(`${skillName} 升级成功！`, 'success');
                closeModal();
                updateAllDisplays();
            } else {
                showNotification('灵石不足！', 'error');
            }
        }

        // 更新装备
        function updateEquipment() {
            const equipment = gameData.character.equipment;
            document.getElementById('weapon-slot').textContent = equipment.weapon || '无';
            document.getElementById('armor-slot').textContent = equipment.armor || '无';
            document.getElementById('accessory-slot').textContent = equipment.accessory || '无';
            document.getElementById('technique-slot').textContent = equipment.technique || '基础吐纳术';
        }

        // 地图系统
        function switchMap(mapName) {
            gameData.currentMap = mapName;
            gameData.character.position = { x: 4, y: 4, map: mapName };
            
            // 更新地图选择样式
            document.querySelectorAll('[id^="map-"]').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`map-${mapName}`).classList.add('active');
            
            // 更新地图信息
            const mapData = gameData.maps[mapName];
            document.getElementById('current-map-name').textContent = mapData.name;
            document.getElementById('current-map-desc').textContent = mapData.desc;
            
            generateMap();
        }

        function generateMap() {
            const mapGrid = document.getElementById('map-grid');
            const mapData = gameData.maps[gameData.currentMap];
            mapGrid.innerHTML = '';
            
            // 设置网格大小
            mapGrid.style.gridTemplateColumns = `repeat(${mapData.size}, 1fr)`;
            
            for (let y = 0; y < mapData.size; y++) {
                for (let x = 0; x < mapData.size; x++) {
                    const tile = document.createElement('div');
                    tile.className = 'map-tile';
                    tile.onclick = () => moveToTile(x, y);
                    
                    if (x === gameData.character.position.x && y === gameData.character.position.y) {
                        tile.classList.add('player');
                        tile.textContent = '🧙';
                    } else {
                        // 根据地图类型生成不同内容
                        const rand = Math.random();
                        if (rand < 0.15) {
                            tile.classList.add('enemy');
                            tile.textContent = '👹';
                        } else if (rand < 0.25) {
                            tile.classList.add('treasure');
                            tile.textContent = '💰';
                        } else if ((x === 0 && y === 0) || (x === mapData.size-1 && y === mapData.size-1)) {
                            tile.classList.add('town');
                            tile.textContent = '🏘️';
                        } else if (rand < 0.28 && gameData.currentMap !== 'newbie') {
                            tile.classList.add('boss');
                            tile.textContent = '🐉';
                        } else {
                            // 根据地图设置不同地形
                            const terrains = {
                                'newbie': '🌱',
                                'forest': '🌲',
                                'mountain': '⛰️',
                                'ruins': '🏛️'
                            };
                            tile.textContent = terrains[gameData.currentMap] || '🌿';
                        }
                    }
                    
                    mapGrid.appendChild(tile);
                }
            }
        }

        function moveToTile(x, y) {
            const pos = gameData.character.position;
            const mapData = gameData.maps[gameData.currentMap];
            
            // 检查是否相邻
            if (Math.abs(x - pos.x) + Math.abs(y - pos.y) !== 1) {
                showNotification('只能移动到相邻的格子！', 'warning');
                return;
            }
            
            // 检查行动点
            if (gameData.character.actionPoints <= 0) {
                showNotification('行动点不足！请休息恢复', 'error');
                return;
            }
            
            gameData.character.actionPoints -= 1;
            gameData.character.position = { x, y, map: gameData.currentMap };
            
            // 触发事件
            const tileIndex = y * mapData.size + x;
            const tile = document.querySelectorAll('.map-tile')[tileIndex];
            
            if (tile.classList.contains('enemy')) {
                const enemyTypes = ['bandit', 'beast'];
                if (gameData.currentMap !== 'newbie') enemyTypes.push('demon');
                const randomType = enemyTypes[Math.floor(Math.random() * enemyTypes.length)];
                selectEnemy(randomType);
                switchTab('battle');
                startBattle();
            } else if (tile.classList.contains('treasure')) {
                discoverTreasure();
            } else if (tile.classList.contains('town')) {
                enterTown();
            } else if (tile.classList.contains('boss')) {
                selectEnemy('boss');
                switchTab('battle');
                showNotification('遭遇强大的BOSS！', 'warning');
            }
            
            generateMap();
            updateQuestProgress('探索者', 1);
        }

        function discoverTreasure() {
            const treasures = [
                { type: 'gold', value: 100 + Math.floor(Math.random() * 200) },
                { type: 'exp', value: 50 + Math.floor(Math.random() * 100) },
                { type: 'item', value: '治疗药水', count: 2 },
                { type: 'item', value: '法力药水', count: 3 },
                { type: 'equipment', value: '青龙剑' }
            ];
            
            const treasure = treasures[Math.floor(Math.random() * treasures.length)];
            let message = '发现宝藏！';
            
            if (treasure.type === 'gold') {
                gameData.character.gold += treasure.value;
                message += `获得 ${treasure.value} 灵石`;
            } else if (treasure.type === 'exp') {
                gameData.character.exp += treasure.value;
                message += `获得 ${treasure.value} 修为`;
                checkLevelUp();
            } else if (treasure.type === 'item') {
                gameData.character.inventory[treasure.value] = 
                    (gameData.character.inventory[treasure.value] || 0) + (treasure.count || 1);
                message += `获得 ${treasure.value} x${treasure.count || 1}`;
            }
            
            addMessage(message, 'system');
            updateAllDisplays();
        }

        function enterTown() {
            // 恢复行动点和少量生命法力
            gameData.character.actionPoints = gameData.character.maxActionPoints;
            gameData.character.hp = Math.min(gameData.character.maxHp, gameData.character.hp + 20);
            gameData.character.mp = Math.min(gameData.character.maxMp, gameData.character.mp + 15);
            
            addMessage('进入城镇，恢复了体力和行动点', 'system');
            switchTab('shop');
            updateCharacterDisplay();
        }

        // 商店系统
        function updateShop() {
            const shopItems = document.getElementById('shop-items');
            shopItems.innerHTML = '';
            
            const items = SHOP_ITEMS[currentShopTab] || {};
            
            for (const [itemName, item] of Object.entries(items)) {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'skill-card';
                itemDiv.onclick = () => buyItem(itemName);
                
                itemDiv.innerHTML = `
                    <h4>${item.icon} ${itemName}</h4>
                    <p>${item.description}</p>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                        <span style="color: #ed8936; font-weight: bold;">${item.price.toLocaleString()} 灵石</span>
                        <button class="btn btn-primary" onclick="event.stopPropagation(); buyItem('${itemName}')">购买</button>
                    </div>
                `;
                shopItems.appendChild(itemDiv);
            }
        }

        function buyItem(itemName) {
            const item = SHOP_ITEMS[currentShopTab][itemName];
            const char = gameData.character;
            
            if (!item) {
                showNotification('商品不存在！', 'error');
                return;
            }
            
            if (char.gold >= item.price) {
                char.gold -= item.price;
                
                if (item.type === 'technique') {
                    if (!char.techniques.includes(itemName)) {
                        char.techniques.push(itemName);
                        addMessage(`学会了功法：${itemName}`, 'system');
                    } else {
                        showNotification('已经学会了这个功法！', 'warning');
                        char.gold += item.price; // 退还灵石
                        return;
                    }
                } else {
                    char.inventory[itemName] = (char.inventory[itemName] || 0) + 1;
                }
                
                addMessage(`购买了 ${itemName}`, 'system');
                showNotification(`成功购买 ${itemName}！`, 'success');
                updateAllDisplays();
            } else {
                showNotification('灵石不足！', 'error');
            }
        }

        // 任务系统
        function updateQuests() {
            const questList = document.getElementById('quest-list');
            questList.innerHTML = '';
            
            gameData.quests.forEach(quest => {
                const questDiv = document.createElement('div');
                questDiv.className = 'skill-card';
                
                const progressPercent = Math.min((quest.progress / quest.target) * 100, 100);
                const isCompleted = quest.progress >= quest.target && !quest.completed;
                
                questDiv.innerHTML = `
                    <h4>${quest.name} ${quest.completed ? '✅' : ''}</h4>
                    <p>${quest.description}</p>
                    <div style="margin: 10px 0;">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progressPercent}%"></div>
                        </div>
                        <small style="display: flex; justify-content: space-between; margin-top: 5px;">
                            <span>${quest.progress}/${quest.target}</span>
                            <span>${progressPercent.toFixed(1)}%</span>
                        </small>
                    </div>
                    <div style="color: #48bb78; font-weight: bold;">
                        奖励: ${quest.reward.gold ? quest.reward.gold + ' 灵石 ' : ''}
                        ${quest.reward.exp ? quest.reward.exp + ' 修为 ' : ''}
                        ${quest.reward.item ? quest.reward.item : ''}
                    </div>
                    ${isCompleted ? '<button class="btn btn-success" onclick="completeQuest(' + quest.id + ')" style="width: 100%; margin-top: 10px;">领取奖励</button>' : ''}
                `;
                
                questList.appendChild(questDiv);
            });
        }

        function updateQuestProgress(questName, amount) {
            const quest = gameData.quests.find(q => q.name === questName);
            if (quest && !quest.completed) {
                quest.progress = Math.min(quest.target, quest.progress + amount);
                updateQuests();
                
                if (quest.progress >= quest.target) {
                    showNotification(`任务完成：${quest.name}！`, 'success');
                }
            }
        }

        function completeQuest(questId) {
            const quest = gameData.quests.find(q => q.id === questId);
            if (quest && quest.progress >= quest.target && !quest.completed) {
                quest.completed = true;
                
                if (quest.reward.gold) {
                    gameData.character.gold += quest.reward.gold;
                }
                if (quest.reward.exp) {
                    gameData.character.exp += quest.reward.exp;
                    checkLevelUp();
                }
                if (quest.reward.item) {
                    gameData.character.inventory[quest.reward.item] = 
                        (gameData.character.inventory[quest.reward.item] || 0) + 1;
                }
                
                gameData.statistics.questsCompleted += 1;
                addMessage(`完成任务：${quest.name}！`, 'quest');
                showNotification(`任务完成：${quest.name}！`, 'success');
                updateAllDisplays();
                checkAchievements();
            }
        }

        // 成就系统
        function updateAchievements() {
            const achievementList = document.getElementById('achievement-list');
            achievementList.innerHTML = '';
            
            gameData.achievements.forEach(achievement => {
                const achievementDiv = document.createElement('div');
                achievementDiv.className = `skill-card ${achievement.unlocked ? '' : 'disabled'}`;
                
                let progress = '';
                const char = gameData.character;
                const stats = gameData.statistics;
                
                switch(achievement.condition.type) {
                    case 'level':
                        progress = `${char.level}/${achievement.condition.value}`;
                        break;
                    case 'battles_won':
                        progress = `${stats.battlesWon}/${achievement.condition.value}`;
                        break;
                    case 'gold':
                        progress = `${char.gold}/${achievement.condition.value}`;
                        break;
                }
                
                achievementDiv.innerHTML = `
                    <h4>🏆 ${achievement.name} ${achievement.unlocked ? '✅' : ''}</h4>
                    <p>${achievement.description}</p>
                    <div style="margin-top: 10px;">
                        <small>进度: ${progress}</small>
                    </div>
                    <div style="color: #ed8936; font-weight: bold; margin-top: 5px;">
                        奖励: ${achievement.reward.gold ? achievement.reward.gold + ' 灵石 ' : ''}
                        ${achievement.reward.exp ? achievement.reward.exp + ' 修为' : ''}
                    </div>
                `;
                
                achievementList.appendChild(achievementDiv);
            });
        }

        function checkAchievements() {
            const char = gameData.character;
            const stats = gameData.statistics;
            
            gameData.achievements.forEach(achievement => {
                if (achievement.unlocked) return;
                
                let completed = false;
                switch(achievement.condition.type) {
                    case 'level':
                        completed = char.level >= achievement.condition.value;
                        break;
                    case 'battles_won':
                        completed = stats.battlesWon >= achievement.condition.value;
                        break;
                    case 'gold':
                        completed = char.gold >= achievement.condition.value;
                        break;
                }
                
                if (completed) {
                    achievement.unlocked = true;
                    
                    if (achievement.reward.gold) {
                        char.gold += achievement.reward.gold;
                    }
                    if (achievement.reward.exp) {
                        char.exp += achievement.reward.exp;
                        checkLevelUp();
                    }
                    
                    showAchievementPopup(achievement.name, achievement.description);
                    addMessage(`解锁成就：${achievement.name}！`, 'quest');
                }
            });
            
            updateAchievements();
        }

        // 更新统计
        function updateStatistics() {
            const stats = gameData.statistics;
            document.getElementById('days-count').textContent = gameData.character.day;
            document.getElementById('battles-won').textContent = stats.battlesWon;
            document.getElementById('enemies-defeated').textContent = stats.enemiesDefeated;
            document.getElementById('quests-completed').textContent = stats.questsCompleted;
        }

        // 战斗系统增强
        let battleTurn = 0;

        function selectEnemy(enemyType) {
            currentEnemy = JSON.parse(JSON.stringify(ENEMIES[enemyType])); // 深拷贝
            currentEnemy.maxHp = currentEnemy.hp;
            currentEnemy.mp = 50; // 给敌人一些法力值
            currentEnemy.maxMp = 50;
            
            // 根据玩家等级调整敌人强度
            const playerLevel = gameData.character.level + gameData.character.realmIndex * 10;
            const levelDiff = Math.max(0, playerLevel - currentEnemy.level);
            const multiplier = 1 + levelDiff * 0.1;
            
            currentEnemy.hp = Math.floor(currentEnemy.hp * multiplier);
            currentEnemy.maxHp = currentEnemy.hp;
            currentEnemy.attack = Math.floor(currentEnemy.attack * multiplier);
            currentEnemy.defense = Math.floor(currentEnemy.defense * multiplier);
            
            document.getElementById('enemy-name').textContent = currentEnemy.name;
            document.getElementById('enemy-level').textContent = currentEnemy.level;
            updateBattleDisplay();
        }

        function updateBattleDisplay() {
            const char = gameData.character;
            document.getElementById('player-name').textContent = char.name;
            document.getElementById('player-level').textContent = char.level;
            
            const playerHpPercent = (char.hp / char.maxHp) * 100;
            document.getElementById('player-hp-bar').style.width = playerHpPercent + '%';
            document.getElementById('player-hp-bar').textContent = `${char.hp}/${char.maxHp}`;
            
            const playerMpPercent = (char.mp / char.maxMp) * 100;
            document.getElementById('player-mp-bar').style.width = playerMpPercent + '%';
            document.getElementById('player-mp-bar').textContent = `${char.mp}/${char.maxMp}`;
            
            if (currentEnemy) {
                const enemyHpPercent = (currentEnemy.hp / currentEnemy.maxHp) * 100;
                document.getElementById('enemy-hp-bar').style.width = enemyHpPercent + '%';
                document.getElementById('enemy-hp-bar').textContent = `${currentEnemy.hp}/${currentEnemy.maxHp}`;
                
                document.getElementById('enemy-card').querySelector('.character-avatar').textContent = currentEnemy.icon;
            }
        }

        function startBattle() {
            if (!currentEnemy) {
                showNotification('请先选择对手！', 'warning');
                return;
            }
            
            gameData.battle.inBattle = true;
            gameData.battle.enemy = currentEnemy;
            gameData.battle.playerTurn = true;
            gameData.battle.round = 0;
            battleTurn = 0;
            
            // 重置技能冷却
            gameData.character.skills.forEach(skill => skill.cooldown = 0);
            
            document.getElementById('start-battle-btn').style.display = 'none';
            document.getElementById('battle-actions').style.display = 'block';
            
            addMessage(`开始与 ${currentEnemy.name} 战斗！`, 'battle');
            updateBattleDisplay();
        }

        function normalAttack() {
            if (!gameData.battle.inBattle || !gameData.battle.playerTurn) return;
            
            const char = gameData.character;
            const enemy = gameData.battle.enemy;
            
            // 计算伤害
            let damage = Math.max(1, char.attack - enemy.defense + Math.floor(Math.random() * 11) - 5);
            
            // 暴击计算
            const isCritical = Math.random() * 100 < char.critRate;
            if (isCritical) {
                damage = Math.floor(damage * 2);
                addMessage(`暴击！对 ${enemy.name} 造成了 ${damage} 点伤害`, 'battle');
                showFloatingDamage(document.getElementById('enemy-card'), damage, true);
            } else {
                addMessage(`对 ${enemy.name} 造成了 ${damage} 点伤害`, 'battle');
                showFloatingDamage(document.getElementById('enemy-card'), damage, false);
            }
            
            enemy.hp -= damage;
            gameData.statistics.totalDamageDealt += damage;
            
            if (enemy.hp <= 0) {
                winBattle();
            } else {
                endPlayerTurn();
            }
            
            updateBattleDisplay();
        }

        function showSkillsInBattle() {
            const char = gameData.character;
            const availableSkills = char.skills.filter(skill => 
                skill.unlocked && skill.cooldown === 0 && char.mp >= skill.cost
            );
            
            if (availableSkills.length === 0) {
                showNotification('没有可用的技能！', 'warning');
                return;
            }
            
            let skillsHtml = '<h3>选择技能</h3><div class="skill-list">';
            availableSkills.forEach(skill => {
                const skillData = SKILL_DATA[skill.name];
                skillsHtml += `
                    <div class="skill-card" onclick="useSkillInBattle('${skill.name}')">
                        <h4>${skill.name}</h4>
                        <p>${skillData.description}</p>
                        <small>消耗: ${skillData.cost} MP</small>
                    </div>
                `;
            });
            skillsHtml += '</div>';
            
            showModal('使用技能', skillsHtml);
        }

        function useSkillInBattle(skillName) {
            closeModal();
            
            const char = gameData.character;
            const skill = char.skills.find(s => s.name === skillName);
            const skillData = SKILL_DATA[skillName];
            const enemy = gameData.battle.enemy;
            
            if (!skill || skill.cooldown > 0 || char.mp < skillData.cost) {
                showNotification('无法使用该技能！', 'error');
                return;
            }
            
            char.mp -= skillData.cost;
            skill.cooldown = skillData.cooldown;
            
            switch(skillData.effect) {
                case 'damage':
                    let damage = Math.floor((char.attack * skillData.power) - enemy.defense + Math.floor(Math.random() * 11) - 5);
                    damage = Math.max(1, damage);
                    
                    // 属性相克加成
                    if (char.spiritualRoot.type === skillData.element) {
                        damage = Math.floor(damage * 1.2);
                    }
                    
                    enemy.hp -= damage;
                    addMessage(`使用 ${skillName}，对 ${enemy.name} 造成了 ${damage} 点伤害`, 'battle');
                    showFloatingDamage(document.getElementById('enemy-card'), damage, false);
                    gameData.statistics.totalDamageDealt += damage;
                    break;
                    
                case 'heal':
                    const healAmount = Math.floor(char.maxHp * skillData.power);
                    char.hp = Math.min(char.maxHp, char.hp + healAmount);
                    addMessage(`使用 ${skillName}，恢复了 ${healAmount} 点生命值`, 'battle');
                    showFloatingText(document.getElementById('player-card'), `+${healAmount}`, '#48bb78');
                    break;
                    
                case 'buff_defense':
                    const buffAmount = Math.floor(char.defense * skillData.power);
                    char.defense += buffAmount;
                    addMessage(`使用 ${skillName}，防御力提升 ${buffAmount} 点`, 'battle');
                    break;
            }
            
            if (enemy.hp <= 0) {
                winBattle();
            } else {
                endPlayerTurn();
            }
            
            updateBattleDisplay();
        }

        function showItemsInBattle() {
            const char = gameData.character;
            const usableItems = ['治疗药水', '法力药水', '回春丹'];
            const availableItems = usableItems.filter(item => char.inventory[item] > 0);
            
            if (availableItems.length === 0) {
                showNotification('没有可用的物品！', 'warning');
                return;
            }
            
            let itemsHtml = '<h3>选择物品</h3><div class="skill-list">';
            availableItems.forEach(itemName => {
                const itemData = findItemData(itemName);
                itemsHtml += `
                    <div class="skill-card" onclick="useItemInBattle('${itemName}')">
                        <h4>${itemData.icon} ${itemName}</h4>
                        <p>${itemData.description}</p>
                        <small>数量: ${char.inventory[itemName]}</small>
                    </div>
                `;
            });
            itemsHtml += '</div>';
            
            showModal('使用物品', itemsHtml);
        }

        function useItemInBattle(itemName) {
            closeModal();
            useItem(itemName);
            endPlayerTurn();
        }

        function defend() {
            if (!gameData.battle.inBattle || !gameData.battle.playerTurn) return;
            
            gameData.battle.playerDefending = true;
            addMessage('进入防御姿态，减少50%伤害', 'battle');
            endPlayerTurn();
        }

        function escapeBattle() {
            const escapeChance = Math.max(20, 80 - (currentEnemy.level - gameData.character.level) * 10);
            
            if (Math.random() * 100 < escapeChance) {
                addMessage('成功逃脱战斗！', 'battle');
                endBattle();
            } else {
                addMessage('逃脱失败！', 'battle');
                endPlayerTurn();
            }
        }

        function endPlayerTurn() {
            gameData.battle.playerTurn = false;
            battleTurn++;
            
            // 减少技能冷却
            gameData.character.skills.forEach(skill => {
                if (skill.cooldown > 0) skill.cooldown--;
            });
            
            setTimeout(enemyTurn, 1500);
        }

        function enemyTurn() {
            if (!gameData.battle.inBattle) return;
            
            const char = gameData.character;
            const enemy = gameData.battle.enemy;
            
            // 敌人AI选择行动
            let action = 'attack';
            if (enemy.skills && enemy.skills.length > 1 && Math.random() < 0.3) {
                action = 'skill';
            }
            
            if (action === 'attack') {
                let damage = Math.max(1, enemy.attack - char.defense + Math.floor(Math.random() * 11) - 5);
                
                if (gameData.battle.playerDefending) {
                    damage = Math.floor(damage * 0.5);
                    gameData.battle.playerDefending = false;
                }
                
                char.hp -= damage;
                gameData.statistics.totalDamageTaken += damage;
                addMessage(`${enemy.name} 攻击你，造成了 ${damage} 点伤害`, 'battle');
                showFloatingDamage(document.getElementById('player-card'), damage, false);
            } else if (action === 'skill') {
                // 敌人使用技能
                const skillName = enemy.skills[Math.floor(Math.random() * enemy.skills.length)];
                let skillDamage = Math.floor(enemy.attack * 1.3);
                char.hp -= skillDamage;
                addMessage(`${enemy.name} 使用 ${skillName}，对你造成了 ${skillDamage} 点伤害`, 'battle');
                showFloatingDamage(document.getElementById('player-card'), skillDamage, false);
            }
            
            if (char.hp <= 0) {
                loseBattle();
            } else {
                gameData.battle.playerTurn = true;
            }
            
            updateBattleDisplay();
        }

        function winBattle() {
            const enemy = gameData.battle.enemy;
            const char = gameData.character;
            
            // 计算奖励
            let goldReward = enemy.reward.gold;
            let expReward = enemy.reward.exp;
            
            // 等级差奖励加成
            const levelDiff = Math.max(0, enemy.level - (char.level + char.realmIndex * 10));
            const bonusMultiplier = 1 + levelDiff * 0.1;
            
            goldReward = Math.floor(goldReward * bonusMultiplier);
            expReward = Math.floor(expReward * bonusMultiplier);
            
            char.gold += goldReward;
            char.exp += expReward;
            
            gameData.statistics.battlesWon += 1;
            gameData.statistics.enemiesDefeated += 1;
            
            addMessage(`战斗胜利！获得 ${goldReward} 灵石和 ${expReward} 修为`, 'battle');
            showNotification('战斗胜利！', 'success');
            
            // 随机掉落物品
            if (Math.random() < 0.3) {
                const dropItems = ['治疗药水', '法力药水', '聚气丹'];
                const dropItem = dropItems[Math.floor(Math.random() * dropItems.length)];
                char.inventory[dropItem] = (char.inventory[dropItem] || 0) + 1;
                addMessage(`额外获得战利品：${dropItem}`, 'battle');
            }
            
            // 更新任务进度
            if (enemy.name.includes('强盗')) {
                updateQuestProgress('战胜强盗', 1);
            }
            
            checkLevelUp();
            endBattle();
        }

        function loseBattle() {
            const char = gameData.character;
            char.hp = Math.floor(char.maxHp * 0.1); // 保留10%生命值
            
            // 损失一些灵石
            const goldLoss = Math.floor(char.gold * 0.05);
            char.gold = Math.max(0, char.gold - goldLoss);
            
            addMessage(`战斗失败！重伤逃脱，损失 ${goldLoss} 灵石`, 'battle');
            showNotification('战斗失败！', 'error');
            endBattle();
        }

        function endBattle() {
            gameData.battle.inBattle = false;
            gameData.battle.enemy = null;
            gameData.battle.playerTurn = true;
            currentEnemy = null;
            
            document.getElementById('start-battle-btn').style.display = 'block';
            document.getElementById('battle-actions').style.display = 'none';
            
            document.getElementById('enemy-name').textContent = '选择对手';
            document.getElementById('enemy-level').textContent = '--';
            document.getElementById('enemy-hp-bar').style.width = '100%';
            document.getElementById('enemy-hp-bar').textContent = '--/--';
            document.getElementById('enemy-card').querySelector('.character-avatar').textContent = '❓';
            
            updateCharacterDisplay();
        }

        function randomBattle() {
            const enemyTypes = ['bandit', 'beast'];
            if (gameData.character.level > 5) enemyTypes.push('demon');
            if (gameData.character.level > 20) enemyTypes.push('boss');
            
            const randomType = enemyTypes[Math.floor(Math.random() * enemyTypes.length)];
            selectEnemy(randomType);
            switchTab('battle');
            setTimeout(() => startBattle(), 500);
        }

        // 特效函数
        function showFloatingText(element, text, color) {
            const floating = document.createElement('div');
            floating.className = 'floating-damage';
            floating.textContent = text;
            floating.style.color = color;
            floating.style.left = (element.offsetLeft + element.offsetWidth / 2) + 'px';
            floating.style.top = (element.offsetTop + element.offsetHeight / 2) + 'px';
            
            element.parentNode.appendChild(floating);
            setTimeout(() => {
                if (floating.parentNode) {
                    floating.parentNode.removeChild(floating);
                }
            }, 2000);
        }

        function showFloatingDamage(element, damage, isCritical) {
            const floating = document.createElement('div');
            floating.className = `floating-damage ${isCritical ? 'critical-hit' : ''}`;
            floating.textContent = `-${damage}`;
            floating.style.color = isCritical ? '#e53e3e' : '#f56565';
            floating.style.left = (element.offsetLeft + element.offsetWidth / 2) + 'px';
            floating.style.top = (element.offsetTop + element.offsetHeight / 2) + 'px';
            
            element.parentNode.appendChild(floating);
            setTimeout(() => {
                if (floating.parentNode) {
                    floating.parentNode.removeChild(floating);
                }
            }, 2000);
        }

        function showAchievementPopup(title, description) {
            const popup = document.createElement('div');
            popup.className = 'achievement-popup';
            popup.innerHTML = `
                <h2>🏆 成就解锁！</h2>
                <h3>${title}</h3>
                <p>${description}</p>
                <button class="btn btn-primary" onclick="this.parentNode.remove()">确定</button>
            `;
            
            document.body.appendChild(popup);
            setTimeout(() => popup.classList.add('show'), 100);
            setTimeout(() => {
                popup.classList.remove('show');
                setTimeout(() => {
                    if (popup.parentNode) {
                        document.body.removeChild(popup);
                    }
                }, 300);
            }, 5000);
        }

        // 设置系统
        function showSettings() {
            const settings = gameData.settings;
            showModal('游戏设置', `
                <div>
                    <label>
                        <input type="checkbox" ${settings.autoSave ? 'checked' : ''} onchange="gameData.settings.autoSave = this.checked">
                        自动保存
                    </label>
                </div>
                <div style="margin: 10px 0;">
                    <label>
                        <input type="checkbox" ${settings.soundEnabled ? 'checked' : ''} onchange="gameData.settings.soundEnabled = this.checked">
                        音效开启
                    </label>
                </div>
                <div>
                    <label>
                        <input type="checkbox" ${settings.animationsEnabled ? 'checked' : ''} onchange="gameData.settings.animationsEnabled = this.checked">
                        动画效果
                    </label>
                </div>
                <hr style="margin: 20px 0;">
                <div>
                    <h4>导出/导入存档</h4>
                    <button class="btn btn-primary" onclick="exportSave()" style="margin: 5px;">导出存档</button>
                    <button class="btn btn-success" onclick="importSave()" style="margin: 5px;">导入存档</button>
                </div>
            `, [
                { text: '确定', class: 'btn-primary', onclick: 'closeModal()' }
            ]);
        }

        function exportSave() {
            try {
                const saveData = JSON.stringify(gameData, null, 2);
                const blob = new Blob([saveData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `cultivation_save_${new Date().toISOString().slice(0, 10)}.json`;
                a.click();
                URL.revokeObjectURL(url);
                showNotification('存档导出成功！', 'success');
            } catch (error) {
                showNotification('导出失败！', 'error');
            }
        }

        function importSave() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const importedData = JSON.parse(e.target.result);
                            gameData = importedData;
                            updateAllDisplays();
                            generateMap();
                            showNotification('存档导入成功！', 'success');
                            closeModal();
                        } catch (error) {
                            showNotification('导入失败，文件格式错误！', 'error');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        // 存档系统
        function saveGame() {
            try {
                localStorage.setItem('cultivationGameSave', JSON.stringify(gameData));
                localStorage.setItem('cultivationGameLastSave', Date.now().toString());
                showNotification('游戏保存成功！', 'success');
            } catch (error) {
                showNotification('保存失败！', 'error');
            }
        }

        function loadGame() {
            try {
                const saveData = localStorage.getItem('cultivationGameSave');
                if (saveData) {
                    gameData = JSON.parse(saveData);
                    updateAllDisplays();
                    generateMap();
                    showNotification('游戏加载成功！', 'success');
                    addMessage('从存档中加载游戏', 'system');
                } else {
                    showNotification('没有找到存档！', 'warning');
                }
            } catch (error) {
                showNotification('加载失败！', 'error');
            }
        }

        function resetGame() {
            showModal('重置游戏', '确定要重置游戏吗？这将清除所有进度！', [
                { text: '确定重置', class: 'btn-danger', onclick: 'confirmReset()' },
                { text: '取消', class: 'btn-primary', onclick: 'closeModal()' }
            ]);
        }

        function confirmReset() {
            localStorage.removeItem('cultivationGameSave');
            localStorage.removeItem('cultivationGameLastSave');
            location.reload();
        }

        // 初始化游戏
        window.onload = function() {
            // 尝试加载存档
            const saveData = localStorage.getItem('cultivationGameSave');
            if (saveData) {
                try {
                    gameData = JSON.parse(saveData);
                    addMessage('从存档中加载游戏', 'system');
                } catch (error) {
                    console.log('存档损坏，使用默认数据');
                    addMessage('存档损坏，重新开始游戏', 'system');
                }
            }
            
            initGame();
            
            // 点击模态框外部关闭
            document.getElementById('modal-overlay').onclick = function(e) {
                if (e.target === this) {
                    closeModal();
                }
            };
        };

        // 键盘快捷键
        document.addEventListener('keydown', function(e) {
            if (e.target.tagName === 'INPUT') return; // 忽略输入框
            
            switch(e.key) {
                case 'c':
                case 'C':
                    cultivate();
                    break;
                case 'a':
                case 'A':
                    adventure();
                    break;
                case 'b':
                case 'B':
                    if (!gameData.battle.inBattle) {
                        randomBattle();
                    }
                    break;
                case 's':
                case 'S':
                    if (e.ctrlKey) {
                        e.preventDefault();
                        saveGame();
                    }
                    break;
                case 'Escape':
                    closeModal();
                    break;
                case ' ':
                    e.preventDefault();
                    if (gameData.battle.inBattle && gameData.battle.playerTurn) {
                        normalAttack();
                    }
                    break;
            }
        });

        // 定期自动保存
        setInterval(() => {
            if (gameData.settings.autoSave) {
                saveGame();
            }
        }, 300000); // 每5分钟自动保存

        // 页面关闭前保存
        window.addEventListener('beforeunload', function() {
            if (gameData.settings.autoSave) {
                localStorage.setItem('cultivationGameSave', JSON.stringify(gameData));
                localStorage.setItem('cultivationGameLastSave', Date.now().toString());
            }
        });

        // 页面可见性变化处理（用于离线收益计算）
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                // 页面隐藏时记录时间
                localStorage.setItem('cultivationGameLastActive', Date.now().toString());
            } else {
                // 页面重新可见时检查离线收益
                checkOfflineProgress();
            }
        });
    </script>
</body>
</html>