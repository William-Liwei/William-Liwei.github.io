<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¿®ä»™æ”¾ç½®æ¸¸æˆ - å®Œæ•´ç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
        }

        .game-container {
            display: grid;
            grid-template-columns: 350px 1fr 300px;
            grid-template-rows: 60px 1fr;
            height: 100vh;
            gap: 10px;
            padding: 10px;
        }

        .header {
            grid-column: 1 / -1;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .game-title {
            font-size: 24px;
            font-weight: bold;
            color: #4a5568;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .online-status {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 14px;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #48bb78;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .save-load {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            font-size: 14px;
            position: relative;
            overflow: hidden;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: linear-gradient(135deg, #4299e1, #63b3ed);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #48bb78, #68d391);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #f56565, #fc8181);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ed8936, #f6ad55);
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .character-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
        }

        .main-area {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
        }

        .sidebar {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
        }

        .section-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #2d3748;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .character-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .info-item {
            background: linear-gradient(135deg, #f7fafc, #edf2f7);
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid #4299e1;
            transition: all 0.3s ease;
        }

        .info-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .info-label {
            font-size: 12px;
            color: #718096;
            margin-bottom: 3px;
            font-weight: 500;
        }

        .info-value {
            font-size: 16px;
            font-weight: bold;
            color: #2d3748;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4299e1, #63b3ed);
            transition: width 0.5s ease;
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .actions-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab-container {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid #e2e8f0;
            margin-bottom: 20px;
            overflow-x: auto;
        }

        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border: none;
            background: transparent;
            font-size: 14px;
            font-weight: 500;
            color: #718096;
            transition: all 0.3s ease;
            white-space: nowrap;
            position: relative;
        }

        .tab:hover {
            color: #4299e1;
            background: rgba(66, 153, 225, 0.1);
        }

        .tab.active {
            color: #4299e1;
            border-bottom: 2px solid #4299e1;
            background: rgba(66, 153, 225, 0.1);
        }

        .tab-content {
            display: none;
            flex: 1;
            overflow-y: auto;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-log {
            background: #1a202c;
            color: #e2e8f0;
            border: 1px solid #2d3748;
            border-radius: 8px;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Consolas', monospace;
            font-size: 12px;
            line-height: 1.6;
        }

        .message-log::-webkit-scrollbar {
            width: 6px;
        }

        .message-log::-webkit-scrollbar-track {
            background: #2d3748;
        }

        .message-log::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 3px;
        }

        .log-message {
            margin-bottom: 2px;
            opacity: 0;
            animation: messageSlide 0.3s ease forwards;
        }

        @keyframes messageSlide {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .log-message.system { color: #48bb78; }
        .log-message.battle { color: #f56565; }
        .log-message.level { color: #ed8936; }
        .log-message.quest { color: #9f7aea; }

        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .inventory-slot {
            aspect-ratio: 1;
            background: linear-gradient(135deg, #f7fafc, #edf2f7);
            border: 2px dashed #e2e8f0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .inventory-slot.occupied {
            background: linear-gradient(135deg, #e6fffa, #b2f5ea);
            border-color: #38b2ac;
            border-style: solid;
        }

        .inventory-slot:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .item-icon {
            font-size: 28px;
        }

        .item-count {
            position: absolute;
            bottom: 2px;
            right: 2px;
            background: linear-gradient(135deg, #4299e1, #63b3ed);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .battle-arena {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            margin-bottom: 20px;
            align-items: center;
        }

        .character-card {
            background: linear-gradient(135deg, #f7fafc, #edf2f7);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            position: relative;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .character-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
        }

        .character-avatar {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 50%;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            color: white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
        }

        .character-avatar::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: avatarShine 3s infinite;
        }

        @keyframes avatarShine {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .vs-indicator {
            font-size: 48px;
            color: #e53e3e;
            font-weight: bold;
            animation: vsGlow 2s infinite alternate;
        }

        @keyframes vsGlow {
            from { text-shadow: 0 0 5px #e53e3e; }
            to { text-shadow: 0 0 20px #e53e3e, 0 0 30px #e53e3e; }
        }

        .hp-bar {
            width: 100%;
            height: 25px;
            background: #fed7d7;
            border-radius: 12px;
            overflow: hidden;
            margin-top: 15px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .hp-fill {
            height: 100%;
            background: linear-gradient(90deg, #f56565, #fc8181);
            transition: width 0.8s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
            position: relative;
        }

        .skill-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }

        .skill-card {
            background: linear-gradient(135deg, #f7fafc, #edf2f7);
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .skill-card:hover {
            background: linear-gradient(135deg, #edf2f7, #e2e8f0);
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }

        .skill-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .skill-card.disabled:hover {
            transform: none;
        }

        .skill-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: left 0.5s ease;
        }

        .skill-card:hover::before {
            left: 100%;
        }

        .skill-cooldown {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #e53e3e;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .map-container {
            display: flex;
            gap: 20px;
        }

        .map-selection {
            width: 200px;
        }

        .map-area {
            flex: 1;
        }

        .map-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 3px;
            max-width: 500px;
            margin: 0 auto 20px;
            background: #2d3748;
            padding: 10px;
            border-radius: 10px;
        }

        .map-tile {
            aspect-ratio: 1;
            border: 1px solid #4a5568;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
            position: relative;
            background: #1a202c;
        }

        .map-tile.player {
            background: linear-gradient(135deg, #4299e1, #63b3ed);
            color: white;
            box-shadow: 0 0 10px #4299e1;
            animation: playerGlow 2s infinite alternate;
        }

        @keyframes playerGlow {
            from { box-shadow: 0 0 10px #4299e1; }
            to { box-shadow: 0 0 20px #4299e1, 0 0 30px #4299e1; }
        }

        .map-tile.enemy {
            background: linear-gradient(135deg, #f56565, #fc8181);
            color: white;
        }

        .map-tile.treasure {
            background: linear-gradient(135deg, #ed8936, #f6ad55);
            color: white;
            animation: treasureShine 3s infinite;
        }

        @keyframes treasureShine {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .map-tile.town {
            background: linear-gradient(135deg, #48bb78, #68d391);
            color: white;
        }

        .map-tile.boss {
            background: linear-gradient(135deg, #9f7aea, #b794f6);
            color: white;
            animation: bossFlash 1s infinite alternate;
        }

        @keyframes bossFlash {
            from { opacity: 0.8; }
            to { opacity: 1; }
        }

        .map-tile:hover {
            transform: scale(1.1);
            z-index: 1;
        }

        .auto-cultivation {
            background: linear-gradient(135deg, #f7fafc, #edf2f7);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid #e2e8f0;
        }

        .cultivation-timer {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            color: #4299e1;
            margin: 10px 0;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #48bb78, #68d391);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            min-width: 250px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: linear-gradient(135deg, #f56565, #fc8181);
        }

        .notification.warning {
            background: linear-gradient(135deg, #ed8936, #f6ad55);
        }

        .floating-damage {
            position: absolute;
            font-weight: bold;
            font-size: 18px;
            z-index: 100;
            pointer-events: none;
            animation: floatUp 2s ease-out forwards;
        }

        @keyframes floatUp {
            0% {
                opacity: 1;
                transform: translateY(0);
            }
            100% {
                opacity: 0;
                transform: translateY(-50px);
            }
        }

        .achievement-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            z-index: 1001;
            text-align: center;
            min-width: 300px;
            opacity: 0;
            transform: translate(-50%, -50%) scale(0.5);
            transition: all 0.3s ease;
        }

        .achievement-popup.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
        }

        .modal-overlay.show {
            display: block;
        }

        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 1001;
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4299e1;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ç‰¹æ®Šæ•ˆæœ */
        .critical-hit {
            color: #e53e3e !important;
            font-size: 24px !important;
            text-shadow: 0 0 10px #e53e3e;
            animation: criticalPulse 0.5s ease;
        }

        @keyframes criticalPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        .level-up-effect {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 32px;
            color: #ed8936;
            font-weight: bold;
            pointer-events: none;
            animation: levelUpBurst 2s ease-out forwards;
            z-index: 100;
        }

        @keyframes levelUpBurst {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.5);
            }
            20% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.2);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(1) translateY(-100px);
            }
        }

        .element-fire { border-left-color: #e53e3e; }
        .element-water { border-left-color: #3182ce; }
        .element-earth { border-left-color: #d69e2e; }
        .element-air { border-left-color: #38b2ac; }
        .element-light { border-left-color: #ecc94b; }
        .element-dark { border-left-color: #805ad5; }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1200px) {
            .game-container {
                grid-template-columns: 300px 1fr 250px;
            }
        }

        @media (max-width: 900px) {
            .game-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto 1fr;
            }
            
            .character-panel,
            .sidebar {
                max-height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="header">
            <div class="game-title">
                ğŸ”ï¸ ä¿®ä»™æ”¾ç½®æ¸¸æˆ
                <div class="online-status">
                    <div class="status-indicator"></div>
                    <span>åœ¨çº¿ä¿®ç‚¼ä¸­</span>
                    <span id="online-time">00:00:00</span>
                </div>
            </div>
            <div class="save-load">
                <button class="btn btn-warning" onclick="showSettings()">âš™ï¸ è®¾ç½®</button>
                <button class="btn btn-primary" onclick="saveGame()">ğŸ’¾ ä¿å­˜</button>
                <button class="btn btn-success" onclick="loadGame()">ğŸ“ åŠ è½½</button>
                <button class="btn btn-danger" onclick="resetGame()">ğŸ”„ é‡ç½®</button>
            </div>
        </div>

        <div class="character-panel">
            <h2 class="section-title">
                ğŸ‘¤ è§’è‰²ä¿¡æ¯
                <span id="power-level" style="font-size: 14px; color: #4299e1;">æˆ˜åŠ›: 0</span>
            </h2>
            
            <!-- çµæ ¹å±æ€§ -->
            <div class="info-item element-fire" style="grid-column: 1 / -1; margin-bottom: 10px;">
                <div class="info-label">çµæ ¹å±æ€§</div>
                <div class="info-value" id="spiritual-root">ç«çµæ ¹ (ä¸Šå“)</div>
            </div>
            
            <div class="character-info">
                <div class="info-item">
                    <div class="info-label">å§“å</div>
                    <div class="info-value" id="char-name">ä¿®ä»™è€…</div>
                </div>
                <div class="info-item">
                    <div class="info-label">å¢ƒç•Œ</div>
                    <div class="info-value" id="char-realm">ç»ƒæ°” 1å±‚</div>
                </div>
                <div class="info-item">
                    <div class="info-label">ä¿®ä¸º</div>
                    <div class="info-value" id="char-exp">0</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="exp-progress" style="width: 0%"></div>
                    </div>
                </div>
                <div class="info-item">
                    <div class="info-label">çµçŸ³</div>
                    <div class="info-value" id="char-gold">100</div>
                </div>
                <div class="info-item">
                    <div class="info-label">ç”Ÿå‘½å€¼</div>
                    <div class="info-value" id="char-hp">100/100</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="hp-progress" style="width: 100%; background: linear-gradient(90deg, #f56565, #fc8181);"></div>
                    </div>
                </div>
                <div class="info-item">
                    <div class="info-label">æ³•åŠ›å€¼</div>
                    <div class="info-value" id="char-mp">10/10</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="mp-progress" style="width: 100%; background: linear-gradient(90deg, #4299e1, #63b3ed);"></div>
                    </div>
                </div>
                <div class="info-item">
                    <div class="info-label">æ”»å‡»åŠ›</div>
                    <div class="info-value" id="char-attack">10</div>
                </div>
                <div class="info-item">
                    <div class="info-label">é˜²å¾¡åŠ›</div>
                    <div class="info-value" id="char-defense">5</div>
                </div>
                <div class="info-item">
                    <div class="info-label">é€Ÿåº¦</div>
                    <div class="info-value" id="char-speed">5</div>
                </div>
                <div class="info-item">
                    <div class="info-label">æš´å‡»ç‡</div>
                    <div class="info-value" id="char-crit">5%</div>
                </div>
                <div class="info-item">
                    <div class="info-label">è¿æ°”</div>
                    <div class="info-value" id="char-luck">5</div>
                </div>
                <div class="info-item">
                    <div class="info-label">æ™ºæ…§</div>
                    <div class="info-value" id="char-wisdom">5</div>
                </div>
            </div>

            <!-- è‡ªåŠ¨ä¿®ç‚¼é¢æ¿ -->
            <div class="auto-cultivation">
                <h3 style="text-align: center; margin-bottom: 10px;">ğŸ§˜ è‡ªåŠ¨ä¿®ç‚¼</h3>
                <div class="cultivation-timer" id="auto-timer">æœªå¼€å¯</div>
                <div class="actions-grid">
                    <button class="btn btn-success" onclick="startAutoCultivation()">å¼€å§‹æŒ‚æœº</button>
                    <button class="btn btn-danger" onclick="stopAutoCultivation()">åœæ­¢æŒ‚æœº</button>
                </div>
                <div style="font-size: 12px; text-align: center; color: #666; margin-top: 5px;">
                    ç¦»çº¿æ”¶ç›Š: <span id="offline-bonus">0</span> ä¿®ä¸º/å°æ—¶
                </div>
            </div>

            <h3 class="section-title">âš¡ å¿«é€Ÿæ“ä½œ</h3>
            <div class="actions-grid">
                <button class="btn btn-primary" onclick="cultivate()">ğŸ§˜ ä¿®ç‚¼ (1å¤©)</button>
                <button class="btn btn-success" onclick="adventure()">ğŸ—ºï¸ å†ç»ƒ</button>
                <button class="btn btn-warning" onclick="breakthrough()">âš¡ å°è¯•çªç ´</button>
                <button class="btn btn-danger" onclick="randomBattle()">âš”ï¸ éšæœºæˆ˜æ–—</button>
            </div>
        </div>

        <div class="main-area">
            <div class="tab-container">
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('home')">ğŸ  ä¸»é¡µ</button>
                    <button class="tab" onclick="switchTab('battle')">âš”ï¸ æˆ˜æ–—</button>
                    <button class="tab" onclick="switchTab('skills')">âœ¨ æŠ€èƒ½</button>
                    <button class="tab" onclick="switchTab('map')">ğŸ—ºï¸ åœ°å›¾</button>
                    <button class="tab" onclick="switchTab('shop')">ğŸª å•†åº—</button>
                    <button class="tab" onclick="switchTab('quests')">ğŸ“‹ ä»»åŠ¡</button>
                    <button class="tab" onclick="switchTab('achievement')">ğŸ† æˆå°±</button>
                    <button class="tab" onclick="switchTab('cultivation')">ğŸ§™ ä¿®ç‚¼</button>
                </div>

                <!-- ä¸»é¡µæ ‡ç­¾ -->
                <div class="tab-content active" id="home-tab">
                    <h2 class="section-title">ğŸ“– æ¸¸æˆæ—¥å¿—</h2>
                    <div class="message-log" id="message-log">
                        <div class="log-message system">æ¬¢è¿æ¥åˆ°ä¿®ä»™ä¸–ç•Œï¼å¼€å§‹ä½ çš„ä¿®ä»™ä¹‹è·¯å§ï¼</div>
                    </div>
                </div>

                <!-- æˆ˜æ–—æ ‡ç­¾ -->
                <div class="tab-content" id="battle-tab">
                    <h2 class="section-title">âš”ï¸ æˆ˜æ–—ç«æŠ€åœº</h2>
                    <div class="battle-arena" id="battle-arena">
                        <div class="character-card" id="player-card">
                            <div class="character-avatar">ğŸ§™</div>
                            <h3 id="player-name">ä¿®ä»™è€…</h3>
                            <div>ç­‰çº§: <span id="player-level">1</span></div>
                            <div class="hp-bar">
                                <div class="hp-fill" id="player-hp-bar" style="width: 100%">100/100</div>
                            </div>
                            <div class="hp-bar" style="margin-top: 5px;">
                                <div class="hp-fill" id="player-mp-bar" style="width: 100%; background: linear-gradient(90deg, #4299e1, #63b3ed);">10/10</div>
                            </div>
                        </div>
                        <div class="vs-indicator">âš”ï¸</div>
                        <div class="character-card" id="enemy-card">
                            <div class="character-avatar">â“</div>
                            <h3 id="enemy-name">é€‰æ‹©å¯¹æ‰‹</h3>
                            <div>ç­‰çº§: <span id="enemy-level">--</span></div>
                            <div class="hp-bar">
                                <div class="hp-fill" id="enemy-hp-bar" style="width: 100%">--/--</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <h3>é€‰æ‹©å¯¹æ‰‹</h3>
                            <div class="skill-list">
                                <div class="skill-card" onclick="selectEnemy('bandit')">
                                    <h4>ğŸ—¡ï¸ ç»ƒæ°”æœŸå¼ºç›—</h4>
                                    <p>ç­‰çº§: 2-4</p>
                                    <p>ç”Ÿå‘½å€¼: 80-120</p>
                                    <p>æ”»å‡»åŠ›: 15-25</p>
                                    <div style="color: #48bb78; font-size: 12px;">æ‰è½: çµçŸ³, è£…å¤‡</div>
                                </div>
                                <div class="skill-card" onclick="selectEnemy('beast')">
                                    <h4>ğŸº å¦–å…½</h4>
                                    <p>ç­‰çº§: 3-6</p>
                                    <p>ç”Ÿå‘½å€¼: 150-250</p>
                                    <p>æ”»å‡»åŠ›: 20-35</p>
                                    <div style="color: #48bb78; font-size: 12px;">æ‰è½: å¦–æ ¸, ææ–™</div>
                                </div>
                                <div class="skill-card" onclick="selectEnemy('demon')">
                                    <h4>ğŸ‘º ç­‘åŸºæœŸå¦–é­”</h4>
                                    <p>ç­‰çº§: 10-15</p>
                                    <p>ç”Ÿå‘½å€¼: 400-600</p>
                                    <p>æ”»å‡»åŠ›: 50-80</p>
                                    <div style="color: #e53e3e; font-size: 12px;">å±é™©ï¼éœ€è¦ç­‘åŸºæœŸå®åŠ›</div>
                                </div>
                                <div class="skill-card" onclick="selectEnemy('boss')">
                                    <h4>ğŸ‰ è¿œå¤å·¨é¾™</h4>
                                    <p>ç­‰çº§: 50</p>
                                    <p>ç”Ÿå‘½å€¼: 10000</p>
                                    <p>æ”»å‡»åŠ›: 500</p>
                                    <div style="color: #9f7aea; font-size: 12px;">ä¼ è¯´çº§BOSS</div>
                                </div>
                            </div>
                        </div>
                        <div>
                            <h3>æˆ˜æ–—æ“ä½œ</h3>
                            <div id="battle-actions" style="display: none;">
                                <div class="actions-grid">
                                    <button class="btn btn-danger" onclick="normalAttack()">âš”ï¸ æ™®é€šæ”»å‡»</button>
                                    <button class="btn btn-primary" onclick="showSkillsInBattle()">âœ¨ ä½¿ç”¨æŠ€èƒ½</button>
                                    <button class="btn btn-success" onclick="showItemsInBattle()">ğŸ§ª ä½¿ç”¨ç‰©å“</button>
                                    <button class="btn btn-warning" onclick="defend()">ğŸ›¡ï¸ é˜²å¾¡</button>
                                </div>
                                <button class="btn btn-danger" onclick="escapeBattle()" style="width: 100%; margin-top: 10px;">ğŸƒ é€ƒè·‘</button>
                            </div>
                            <button class="btn btn-success" onclick="startBattle()" id="start-battle-btn" style="width: 100%;">ğŸ¯ å¼€å§‹æˆ˜æ–—</button>
                        </div>
                    </div>
                </div>

                <!-- æŠ€èƒ½æ ‡ç­¾ -->
                <div class="tab-content" id="skills-tab">
                    <h2 class="section-title">âœ¨ æŠ€èƒ½ç³»ç»Ÿ</h2>
                    <div class="skill-list" id="skill-display-list">
                        <!-- æŠ€èƒ½å°†é€šè¿‡JavaScriptç”Ÿæˆ -->
                    </div>
                </div>

                <!-- åœ°å›¾æ ‡ç­¾ -->
                <div class="tab-content" id="map-tab">
                    <h2 class="section-title">ğŸ—ºï¸ ä¸–ç•Œåœ°å›¾</h2>
                    <div class="map-container">
                        <div class="map-selection">
                            <h4>é€‰æ‹©åœ°å›¾åŒºåŸŸ</h4>
                            <div class="skill-list" style="grid-template-columns: 1fr;">
                                <div class="skill-card" onclick="switchMap('newbie')" id="map-newbie">
                                    <h4>ğŸŒ± æ–°æ‰‹æ‘</h4>
                                    <p>ç­‰çº§æ¨è: 1-10</p>
                                </div>
                                <div class="skill-card" onclick="switchMap('forest')" id="map-forest">
                                    <h4>ğŸŒ² è¿·é›¾æ£®æ—</h4>
                                    <p>ç­‰çº§æ¨è: 5-20</p>
                                </div>
                                <div class="skill-card" onclick="switchMap('mountain')" id="map-mountain">
                                    <h4>â›°ï¸ äº‘é›¾å±±è„‰</h4>
                                    <p>ç­‰çº§æ¨è: 15-35</p>
                                </div>
                                <div class="skill-card" onclick="switchMap('ruins')" id="map-ruins">
                                    <h4>ğŸ›ï¸ ä¸Šå¤é—è¿¹</h4>
                                    <p>ç­‰çº§æ¨è: 30+</p>
                                </div>
                            </div>
                        </div>
                        <div class="map-area">
                            <div style="text-align: center; margin-bottom: 10px;">
                                <h3 id="current-map-name">æ–°æ‰‹æ‘</h3>
                                <p id="current-map-desc">å®‰å…¨çš„ä¿®ç‚¼ä¹‹åœ°</p>
                            </div>
                            <div class="map-grid" id="map-grid">
                                <!-- åœ°å›¾å°†é€šè¿‡JavaScriptç”Ÿæˆ -->
                            </div>
                            <div style="text-align: center;">
                                <p><strong>å›¾ä¾‹ï¼š</strong></p>
                                <p>ğŸ§™ ç©å®¶ | ğŸ‘¹ æ•Œäºº | ğŸ’° å®è— | ğŸ˜ï¸ åŸé•‡ | ğŸ‰ BOSS</p>
                                <p>ç§»åŠ¨æ¶ˆè€—: <span id="movement-cost">1</span> è¡ŒåŠ¨ç‚¹</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å•†åº—æ ‡ç­¾ -->
                <div class="tab-content" id="shop-tab">
                    <h2 class="section-title">ğŸª å¤©æåœ°å®åŠ</h2>
                    <div class="tabs" style="border-bottom: 1px solid #e2e8f0; margin-bottom: 15px;">
                        <button class="tab active" onclick="switchShopTab('items')">ğŸ“¦ ç‰©å“</button>
                        <button class="tab" onclick="switchShopTab('equipment')">âš”ï¸ è£…å¤‡</button>
                        <button class="tab" onclick="switchShopTab('pills')">ğŸ’Š ä¸¹è¯</button>
                        <button class="tab" onclick="switchShopTab('techniques')">ğŸ“œ åŠŸæ³•</button>
                    </div>
                    <div id="shop-items">
                        <!-- å•†åº—ç‰©å“å°†é€šè¿‡JavaScriptç”Ÿæˆ -->
                    </div>
                </div>

                <!-- ä»»åŠ¡æ ‡ç­¾ -->
                <div class="tab-content" id="quests-tab">
                    <h2 class="section-title">ğŸ“‹ ä»™é—¨ä»»åŠ¡</h2>
                    <div id="quest-list">
                        <!-- ä»»åŠ¡åˆ—è¡¨å°†é€šè¿‡JavaScriptç”Ÿæˆ -->
                    </div>
                </div>

                <!-- æˆå°±æ ‡ç­¾ -->
                <div class="tab-content" id="achievement-tab">
                    <h2 class="section-title">ğŸ† ä¿®ä»™æˆå°±</h2>
                    <div id="achievement-list">
                        <!-- æˆå°±åˆ—è¡¨å°†é€šè¿‡JavaScriptç”Ÿæˆ -->
                    </div>
                </div>

                <!-- ä¿®ç‚¼æ ‡ç­¾ -->
                <div class="tab-content" id="cultivation-tab">
                    <h2 class="section-title">ğŸ§™ ä¿®ç‚¼ç³»ç»Ÿ</h2>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <h3>åŠŸæ³•ä¿®ç‚¼</h3>
                            <div id="technique-list">
                                <!-- åŠŸæ³•åˆ—è¡¨ -->
                            </div>
                        </div>
                        <div>
                            <h3>å¢ƒç•Œçªç ´</h3>
                            <div class="info-item">
                                <div class="info-label">å½“å‰å¢ƒç•Œ</div>
                                <div class="info-value" id="breakthrough-current">ç»ƒæ°” 1å±‚</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">çªç ´æˆåŠŸç‡</div>
                                <div class="info-value" id="breakthrough-chance">95%</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">æ‰€éœ€ä¿®ä¸º</div>
                                <div class="info-value" id="breakthrough-cost">100</div>
                            </div>
                            <button class="btn btn-warning" onclick="attemptBreakthrough()" style="width: 100%; margin-top: 10px;">âš¡ å¼€å§‹çªç ´</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä¾§è¾¹æ  -->
        <div class="sidebar">
            <h2 class="section-title">ğŸ’ èƒŒåŒ…ç‰©å“</h2>
            <div class="inventory-grid" id="inventory">
                <!-- èƒŒåŒ…ç‰©å“å°†é€šè¿‡JavaScriptç”Ÿæˆ -->
            </div>

            <h2 class="section-title" style="margin-top: 20px;">âš”ï¸ è£…å¤‡æ </h2>
            <div id="equipment-slots">
                <div class="info-item">
                    <div class="info-label">æ­¦å™¨</div>
                    <div class="info-value" id="weapon-slot">æ— </div>
                </div>
                <div class="info-item">
                    <div class="info-label">æŠ¤ç”²</div>
                    <div class="info-value" id="armor-slot">æ— </div>
                </div>
                <div class="info-item">
                    <div class="info-label">é¥°å“</div>
                    <div class="info-value" id="accessory-slot">æ— </div>
                </div>
                <div class="info-item">
                    <div class="info-label">åŠŸæ³•</div>
                    <div class="info-value" id="technique-slot">åŸºç¡€åçº³æœ¯</div>
                </div>
            </div>

            <h2 class="section-title" style="margin-top: 20px;">ğŸ“Š ç»Ÿè®¡æ•°æ®</h2>
            <div id="statistics">
                <div class="info-item">
                    <div class="info-label">ä¿®ç‚¼å¤©æ•°</div>
                    <div class="info-value" id="days-count">1</div>
                </div>
                <div class="info-item">
                    <div class="info-label">æˆ˜æ–—èƒœåˆ©</div>
                    <div class="info-value" id="battles-won">0</div>
                </div>
                <div class="info-item">
                    <div class="info-label">å‡»è´¥æ•Œäºº</div>
                    <div class="info-value" id="enemies-defeated">0</div>
                </div>
                <div class="info-item">
                    <div class="info-label">å®Œæˆä»»åŠ¡</div>
                    <div class="info-value" id="quests-completed">0</div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal" id="modal-content">
            <!-- æ¨¡æ€æ¡†å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>

    <script>
        // æ¸¸æˆæ•°æ®
        let gameData = {
            character: {
                name: "ä¿®ä»™è€…",
                level: 1,
                realmIndex: 0,
                exp: 0,
                gold: 100,
                day: 1,
                hp: 100,
                maxHp: 100,
                mp: 10,
                maxMp: 10,
                attack: 10,
                defense: 5,
                speed: 5,
                luck: 5,
                wisdom: 5,
                charisma: 5,
                critRate: 5,
                spiritualRoot: { type: 'fire', quality: 'high' },
                techniques: ['åŸºç¡€åçº³æœ¯'],
                skills: [
                    { name: 'æ™®é€šæ”»å‡»', level: 1, cooldown: 0, maxCooldown: 0, cost: 0, type: 'physical' },
                    { name: 'ç«çƒæœ¯', level: 1, cooldown: 0, maxCooldown: 2, cost: 10, type: 'fire', unlocked: false }
                ],
                inventory: {
                    'æ²»ç–—è¯æ°´': 3,
                    'æ³•åŠ›è¯æ°´': 2
                },
                equipment: {
                    weapon: null,
                    armor: null,
                    accessory: null,
                    technique: 'åŸºç¡€åçº³æœ¯'
                },
                position: { x: 4, y: 4, map: 'newbie' },
                actionPoints: 10,
                maxActionPoints: 10
            },
            battle: {
                inBattle: false,
                enemy: null,
                playerTurn: true,
                round: 0,
                playerDefending: false,
                enemyDefending: false
            },
            maps: {
                newbie: { name: 'æ–°æ‰‹æ‘', desc: 'å®‰å…¨çš„ä¿®ç‚¼ä¹‹åœ°', size: 8, level: [1, 10] },
                forest: { name: 'è¿·é›¾æ£®æ—', desc: 'å……æ»¡å±é™©çš„ç¥ç§˜ä¹‹åœ°', size: 8, level: [5, 20] },
                mountain: { name: 'äº‘é›¾å±±è„‰', desc: 'é«˜çº§ä¿®å£«çš„è¯•ç‚¼åœº', size: 8, level: [15, 35] },
                ruins: { name: 'ä¸Šå¤é—è¿¹', desc: 'ä¼ è¯´ä¸­çš„è¿œå¤æˆ˜åœº', size: 8, level: [30, 50] }
            },
            currentMap: 'newbie',
            quests: [
                {
                    id: 1,
                    name: "åˆå¿ƒè€…çš„ä¿®ç‚¼",
                    description: "ä¿®ç‚¼10å¤©ï¼Œæ„Ÿå—çµæ°”çš„æµåŠ¨",
                    progress: 0,
                    target: 10,
                    reward: { gold: 50, exp: 100 },
                    completed: false,
                    type: 'cultivation'
                },
                {
                    id: 2,
                    name: "æˆ˜èƒœå¼ºç›—",
                    description: "å‡»è´¥5ä¸ªå¼ºç›—ï¼Œè¯æ˜ä½ çš„å®åŠ›",
                    progress: 0,
                    target: 5,
                    reward: { gold: 100, item: 'é’é¾™å‰‘' },
                    completed: false,
                    type: 'battle'
                },
                {
                    id: 3,
                    name: "æ¢ç´¢è€…",
                    description: "æ¢ç´¢50ä¸ªåœ°å›¾æ ¼å­",
                    progress: 0,
                    target: 50,
                    reward: { gold: 200, exp: 300 },
                    completed: false,
                    type: 'exploration'
                }
            ],
            achievements: [
                {
                    id: 1,
                    name: "ä¿®ä»™å…¥é—¨",
                    description: "è¾¾åˆ°ç»ƒæ°”3å±‚",
                    condition: { type: 'level', value: 3 },
                    reward: { gold: 100 },
                    unlocked: false
                },
                {
                    id: 2,
                    name: "æˆ˜æ–—ä¸“å®¶",
                    description: "èƒœåˆ©10åœºæˆ˜æ–—",
                    condition: { type: 'battles_won', value: 10 },
                    reward: { gold: 200 },
                    unlocked: false
                },
                {
                    id: 3,
                    name: "è´¢å¯Œç§¯ç´¯è€…",
                    description: "æ‹¥æœ‰1000çµçŸ³",
                    condition: { type: 'gold', value: 1000 },
                    reward: { exp: 500 },
                    unlocked: false
                }
            ],
            statistics: {
                battlesWon: 0,
                enemiesDefeated: 0,
                questsCompleted: 0,
                totalDamageDealt: 0,
                totalDamageTaken: 0
            },
            auto: {
                cultivation: false,
                startTime: null,
                offlineBonus: 10
            },
            settings: {
                autoSave: true,
                soundEnabled: true,
                animationsEnabled: true
            }
        };

        // æ¸¸æˆå¸¸é‡
        const CULTIVATION_REALMS = [
            "ç»ƒæ°”", "ç­‘åŸº", "é‡‘ä¸¹", "å…ƒå©´", "åŒ–ç¥", 
            "ç‚¼è™š", "åˆä½“", "å¤§ä¹˜", "æ¸¡åŠ«", "é£å‡"
        ];

        const CULTIVATION_LEVELS = {
            "ç»ƒæ°”": [100, 200, 300, 400, 500, 600, 700, 800, 900],
            "ç­‘åŸº": [500, 800, 1200, 1600, 2000, 2500, 3000, 3500, 4000],
            "é‡‘ä¸¹": [1000, 2000, 3000, 4500, 6000, 8000, 10000, 12000, 15000],
            "å…ƒå©´": [3000, 6000, 10000, 15000, 22000, 30000, 40000, 52000, 66000],
            "åŒ–ç¥": [8000, 16000, 26000, 38000, 52000, 70000, 90000, 115000, 145000],
            "ç‚¼è™š": [20000, 40000, 65000, 95000, 130000, 175000, 225000, 285000, 355000],
            "åˆä½“": [50000, 100000, 160000, 230000, 315000, 415000, 535000, 675000, 840000],
            "å¤§ä¹˜": [120000, 240000, 385000, 555000, 755000, 985000, 1250000, 1555000, 1905000],
            "æ¸¡åŠ«": [300000, 600000, 960000, 1380000, 1865000, 2415000, 3035000, 3725000, 4490000],
            "é£å‡": [750000, 1500000, 2400000, 3450000, 4650000, 6000000, 7500000, 9150000, 10950000]
        };

        const REALM_UPGRADES = {
            "ç»ƒæ°”": {hp: 15, attack: 3, defense: 2, mp: 5, speed: 2, luck: 2, wisdom: 2, charisma: 2, critRate: 1},
            "ç­‘åŸº": {hp: 40, attack: 8, defense: 5, mp: 15, speed: 5, luck: 3, wisdom: 3, charisma: 3, critRate: 2},
            "é‡‘ä¸¹": {hp: 100, attack: 20, defense: 10, mp: 40, speed: 10, luck: 5, wisdom: 5, charisma: 5, critRate: 3},
            "å…ƒå©´": {hp: 250, attack: 50, defense: 25, mp: 100, speed: 20, luck: 8, wisdom: 8, charisma: 8, critRate: 5},
            "åŒ–ç¥": {hp: 600, attack: 120, defense: 60, mp: 250, speed: 40, luck: 12, wisdom: 12, charisma: 12, critRate: 8},
            "ç‚¼è™š": {hp: 1500, attack: 300, defense: 150, mp: 600, speed: 80, luck: 20, wisdom: 20, charisma: 20, critRate: 12},
            "åˆä½“": {hp: 3500, attack: 700, defense: 350, mp: 1400, speed: 150, luck: 30, wisdom: 30, charisma: 30, critRate: 18},
            "å¤§ä¹˜": {hp: 8000, attack: 1600, defense: 800, mp: 3200, speed: 250, luck: 45, wisdom: 45, charisma: 45, critRate: 25},
            "æ¸¡åŠ«": {hp: 18000, attack: 3600, defense: 1800, mp: 7200, speed: 400, luck: 65, wisdom: 65, charisma: 65, critRate: 35},
            "é£å‡": {hp: 40000, attack: 8000, defense: 4000, mp: 16000, speed: 600, luck: 90, wisdom: 90, charisma: 90, critRate: 50}
        };

        // æŠ€èƒ½æ•°æ®
        const SKILL_DATA = {
            'æ™®é€šæ”»å‡»': {
                description: 'åŸºç¡€ç‰©ç†æ”»å‡»',
                cost: 0,
                cooldown: 0,
                effect: 'damage',
                power: 1.0,
                element: 'physical'
            },
            'ç«çƒæœ¯': {
                description: 'å‘å°„ç«çƒé€ æˆç«å±æ€§ä¼¤å®³',
                cost: 10,
                cooldown: 2,
                effect: 'damage',
                power: 1.5,
                element: 'fire',
                unlockLevel: 3
            },
            'æ²»ç–—æœ¯': {
                description: 'æ¢å¤è‡ªèº«ç”Ÿå‘½å€¼',
                cost: 15,
                cooldown: 3,
                effect: 'heal',
                power: 0.3,
                element: 'light',
                unlockLevel: 5
            },
            'é›·å‡»æœ¯': {
                description: 'å¬å”¤é›·ç”µæ”»å‡»æ•Œäºº',
                cost: 25,
                cooldown: 4,
                effect: 'damage',
                power: 2.0,
                element: 'thunder',
                unlockLevel: 8
            },
            'å‰‘æ°”æ–©': {
                description: 'å‡èšå‰‘æ°”è¿œç¨‹æ”»å‡»',
                cost: 20,
                cooldown: 3,
                effect: 'damage',
                power: 1.8,
                element: 'sword',
                unlockLevel: 10
            },
            'é‡‘é’Ÿç½©': {
                description: 'æå‡é˜²å¾¡åŠ›',
                cost: 30,
                cooldown: 5,
                effect: 'buff_defense',
                power: 2.0,
                element: 'earth',
                unlockLevel: 12
            }
        };

        // å•†åº—ç‰©å“
        const SHOP_ITEMS = {
            items: {
                'æ²»ç–—è¯æ°´': { price: 20, description: 'æ¢å¤50ç‚¹ç”Ÿå‘½å€¼', icon: 'ğŸ§ª', type: 'consumable' },
                'æ³•åŠ›è¯æ°´': { price: 15, description: 'æ¢å¤30ç‚¹æ³•åŠ›å€¼', icon: 'ğŸ’™', type: 'consumable' },
                'èšæ°”ä¸¹': { price: 100, description: 'æ°¸ä¹…å¢åŠ 10ç‚¹æ³•åŠ›ä¸Šé™', icon: 'ğŸ’Š', type: 'permanent' },
                'å¼ºèº«ä¸¹': { price: 150, description: 'æ°¸ä¹…å¢åŠ 20ç‚¹ç”Ÿå‘½ä¸Šé™', icon: 'â¤ï¸', type: 'permanent' },
                'æ‚Ÿé“èŒ¶': { price: 200, description: 'è·å¾—200ç‚¹ä¿®ä¸º', icon: 'ğŸµ', type: 'consumable' }
            },
            equipment: {
                'é’é¾™å‰‘': { price: 500, description: 'æ”»å‡»åŠ›+20çš„ç¥å™¨', icon: 'âš”ï¸', type: 'weapon', stats: {attack: 20} },
                'ç„é“ç”²': { price: 400, description: 'é˜²å¾¡åŠ›+15çš„æŠ¤ç”²', icon: 'ğŸ›¡ï¸', type: 'armor', stats: {defense: 15} },
                'çµç‰ä½©': { price: 300, description: 'æ³•åŠ›+15çš„é¥°å“', icon: 'ğŸ’', type: 'accessory', stats: {mp: 15} },
                'çƒˆç„°å‰‘': { price: 1000, description: 'ç«å±æ€§ç¥å‰‘ï¼Œæ”»å‡»+35', icon: 'ğŸ”¥', type: 'weapon', stats: {attack: 35}, element: 'fire' },
                'é¾™é³ç”²': { price: 800, description: 'ä¼ è¯´æŠ¤ç”²ï¼Œé˜²å¾¡+25', icon: 'ğŸ‰', type: 'armor', stats: {defense: 25, hp: 50} }
            },
            pills: {
                'ç­‘åŸºä¸¹': { price: 1000, description: 'è¾…åŠ©çªç ´ç­‘åŸºå¢ƒç•Œ', icon: 'ğŸ”®', type: 'breakthrough' },
                'æ´—é«“ä¸¹': { price: 2000, description: 'æ”¹å–„çµæ ¹èµ„è´¨', icon: 'âœ¨', type: 'enhancement' },
                'å›æ˜¥ä¸¹': { price: 500, description: 'å®Œå…¨æ¢å¤ç”Ÿå‘½å’Œæ³•åŠ›', icon: 'ğŸŒ¸', type: 'consumable' }
            },
            techniques: {
                'çƒˆç«è¯€': { price: 800, description: 'ç«å±æ€§åŠŸæ³•ï¼Œæå‡ç«ç³»æŠ€èƒ½å¨åŠ›', icon: 'ğŸ”¥', type: 'technique', element: 'fire' },
                'ç„æ°´è¯€': { price: 800, description: 'æ°´å±æ€§åŠŸæ³•ï¼Œæå‡é˜²å¾¡å’Œæ¢å¤', icon: 'ğŸŒŠ', type: 'technique', element: 'water' },
                'åšåœŸè¯€': { price: 800, description: 'åœŸå±æ€§åŠŸæ³•ï¼Œå¤§å¹…æå‡ç”Ÿå‘½å€¼', icon: 'ğŸ”ï¸', type: 'technique', element: 'earth' }
            }
        };

        // æ•Œäººæ•°æ®
        const ENEMIES = {
            bandit: { 
                name: 'ç»ƒæ°”æœŸå¼ºç›—', 
                hp: 80, 
                attack: 15, 
                defense: 5, 
                level: 3,
                icon: 'ğŸ—¡ï¸', 
                reward: { gold: 30, exp: 50 },
                skills: ['æ™®é€šæ”»å‡»']
            },
            beast: { 
                name: 'å¦–å…½', 
                hp: 150, 
                attack: 25, 
                defense: 8, 
                level: 5,
                icon: 'ğŸº', 
                reward: { gold: 50, exp: 80 },
                skills: ['æ™®é€šæ”»å‡»', 'æ’•å’¬']
            },
            demon: { 
                name: 'ç­‘åŸºæœŸå¦–é­”', 
                hp: 400, 
                attack: 60, 
                defense: 20, 
                level: 12,
                icon: 'ğŸ‘º', 
                reward: { gold: 100, exp: 200 },
                skills: ['æ™®é€šæ”»å‡»', 'é­”ç„°æœ¯', 'é­”æ°”æŠ¤ä½“']
            },
            boss: { 
                name: 'è¿œå¤å·¨é¾™', 
                hp: 10000, 
                attack: 500, 
                defense: 200, 
                level: 50,
                icon: 'ğŸ‰', 
                reward: { gold: 5000, exp: 10000 },
                skills: ['æ™®é€šæ”»å‡»', 'é¾™æ¯', 'é¾™é³æŠ¤ä½“', 'æ€’å¼']
            }
        };

        // æ¸¸æˆçŠ¶æ€
        let onlineTime = 0;
        let autoCultivationTimer = null;
        let currentEnemy = null;
        let currentShopTab = 'items';

        // åˆå§‹åŒ–æ¸¸æˆ
        function initGame() {
            updateAllDisplays();
            generateMap();
            updateOnlineTime();
            checkOfflineProgress();
            
            // æ¯ç§’æ›´æ–°åœ¨çº¿æ—¶é—´
            setInterval(updateOnlineTime, 1000);
            
            // è‡ªåŠ¨ä¿å­˜
            if (gameData.settings.autoSave) {
                setInterval(saveGame, 60000); // æ¯åˆ†é’Ÿè‡ªåŠ¨ä¿å­˜
            }
        }

        // æ›´æ–°æ‰€æœ‰æ˜¾ç¤º
        function updateAllDisplays() {
            updateCharacterDisplay();
            updateInventory();
            updateSkillList();
            updateEquipment();
            updateQuests();
            updateAchievements();
            updateStatistics();
            updateShop();
            updateBattleDisplay();
        }

        // æ›´æ–°è§’è‰²æ˜¾ç¤º
        function updateCharacterDisplay() {
            const char = gameData.character;
            const realm = CULTIVATION_REALMS[char.realmIndex];
            
            document.getElementById('char-name').textContent = char.name;
            document.getElementById('char-realm').textContent = `${realm} ${char.level}å±‚`;
            document.getElementById('char-exp').textContent = char.exp.toLocaleString();
            document.getElementById('char-gold').textContent = char.gold.toLocaleString();
            document.getElementById('char-hp').textContent = `${char.hp}/${char.maxHp}`;
            document.getElementById('char-mp').textContent = `${char.mp}/${char.maxMp}`;
            document.getElementById('char-attack').textContent = char.attack;
            document.getElementById('char-defense').textContent = char.defense;
            document.getElementById('char-speed').textContent = char.speed;
            document.getElementById('char-crit').textContent = char.critRate + '%';
            document.getElementById('char-luck').textContent = char.luck;
            document.getElementById('char-wisdom').textContent = char.wisdom;

            // è®¡ç®—æˆ˜åŠ›
            const powerLevel = char.attack + char.defense + char.maxHp/10 + char.maxMp/5 + char.speed;
            document.getElementById('power-level').textContent = `æˆ˜åŠ›: ${Math.floor(powerLevel)}`;

            // æ›´æ–°çµæ ¹æ˜¾ç¤º
            const rootTypes = { fire: 'ç«', water: 'æ°´', earth: 'åœŸ', air: 'é£', light: 'å…‰', dark: 'æš—' };
            const rootQualities = { low: 'ä¸‹å“', medium: 'ä¸­å“', high: 'ä¸Šå“', perfect: 'æå“' };
            document.getElementById('spiritual-root').textContent = 
                `${rootTypes[char.spiritualRoot.type]}çµæ ¹ (${rootQualities[char.spiritualRoot.quality]})`;

            // æ›´æ–°è¿›åº¦æ¡
            const expNeeded = char.level <= 9 ? CULTIVATION_LEVELS[realm][char.level - 1] : 0;
            const expProgress = expNeeded > 0 ? (char.exp / expNeeded) * 100 : 100;
            document.getElementById('exp-progress').style.width = Math.min(expProgress, 100) + '%';
            
            const hpProgress = (char.hp / char.maxHp) * 100;
            document.getElementById('hp-progress').style.width = hpProgress + '%';
            
            const mpProgress = (char.mp / char.maxMp) * 100;
            document.getElementById('mp-progress').style.width = mpProgress + '%';

            // æ›´æ–°ä¿®ç‚¼ç›¸å…³æ˜¾ç¤º
            document.getElementById('breakthrough-current').textContent = `${realm} ${char.level}å±‚`;
            document.getElementById('breakthrough-cost').textContent = expNeeded.toLocaleString();
            
            // è®¡ç®—çªç ´æˆåŠŸç‡
            let successRate = 95 - (char.level - 1) * 5;
            if (char.level === 9) successRate = 70; // å¤§å¢ƒç•Œçªç ´æ›´éš¾
            document.getElementById('breakthrough-chance').textContent = Math.max(successRate, 20) + '%';

            // æ›´æ–°ç¦»çº¿æ”¶ç›Š
            document.getElementById('offline-bonus').textContent = gameData.auto.offlineBonus;
        }

        // åœ¨çº¿æ—¶é—´æ›´æ–°
        function updateOnlineTime() {
            onlineTime++;
            const hours = Math.floor(onlineTime / 3600);
            const minutes = Math.floor((onlineTime % 3600) / 60);
            const seconds = onlineTime % 60;
            document.getElementById('online-time').textContent = 
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // è‡ªåŠ¨ä¿®ç‚¼æ”¶ç›Š
            if (gameData.auto.cultivation && onlineTime % 10 === 0) { // æ¯10ç§’è·å¾—æ”¶ç›Š
                const expGain = Math.floor(gameData.auto.offlineBonus / 360); // æ¯å°æ—¶æ”¶ç›Šé™¤ä»¥360
                gameData.character.exp += expGain;
                if (expGain > 0) {
                    addMessage(`è‡ªåŠ¨ä¿®ç‚¼è·å¾— ${expGain} ä¿®ä¸º`, 'system');
                    checkLevelUp();
                    updateCharacterDisplay();
                }
            }
        }

        // æ£€æŸ¥ç¦»çº¿è¿›åº¦
        function checkOfflineProgress() {
            const lastSaveTime = localStorage.getItem('cultivationGameLastSave');
            if (lastSaveTime && gameData.auto.cultivation) {
                const offlineTime = Math.floor((Date.now() - parseInt(lastSaveTime)) / 1000);
                if (offlineTime > 60) { // ç¦»çº¿è¶…è¿‡1åˆ†é’Ÿ
                    const offlineHours = offlineTime / 3600;
                    const offlineExp = Math.floor(offlineHours * gameData.auto.offlineBonus);
                    const offlineGold = Math.floor(offlineHours * 5);
                    
                    gameData.character.exp += offlineExp;
                    gameData.character.gold += offlineGold;
                    
                    showModal('ç¦»çº¿æ”¶ç›Š', `
                        <p>ç¦»çº¿æ—¶é—´: ${Math.floor(offlineHours)}å°æ—¶${Math.floor((offlineTime % 3600) / 60)}åˆ†é’Ÿ</p>
                        <p>è·å¾—ä¿®ä¸º: ${offlineExp.toLocaleString()}</p>
                        <p>è·å¾—çµçŸ³: ${offlineGold.toLocaleString()}</p>
                    `);
                    
                    checkLevelUp();
                }
            }
        }

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
        }

        // åˆ‡æ¢å•†åº—æ ‡ç­¾
        function switchShopTab(tabName) {
            currentShopTab = tabName;
            updateShop();
            
            // æ›´æ–°å•†åº—æ ‡ç­¾æ ·å¼
            document.querySelectorAll('#shop-tab .tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°æ—¥å¿—
        function addMessage(message, type = 'system') {
            const messageLog = document.getElementById('message-log');
            const messageDiv = document.createElement('div');
            messageDiv.className = `log-message ${type}`;
            
            const timestamp = new Date().toLocaleTimeString();
            messageDiv.innerHTML = `<span style="color: #666;">[${timestamp}]</span> ${message}`;
            
            messageLog.appendChild(messageDiv);
            messageLog.scrollTop = messageLog.scrollHeight;
            
            // é™åˆ¶æ¶ˆæ¯æ•°é‡
            while (messageLog.children.length > 100) {
                messageLog.removeChild(messageLog.firstChild);
            }
        }

        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        function showModal(title, content, buttons = []) {
            const overlay = document.getElementById('modal-overlay');
            const modal = document.getElementById('modal-content');
            
            let buttonHtml = '';
            if (buttons.length === 0) {
                buttonHtml = '<button class="btn btn-primary" onclick="closeModal()">ç¡®å®š</button>';
            } else {
                buttonHtml = buttons.map(btn => 
                    `<button class="btn ${btn.class}" onclick="${btn.onclick}">${btn.text}</button>`
                ).join('');
            }
            
            modal.innerHTML = `
                <h2>${title}</h2>
                <div style="margin: 20px 0;">${content}</div>
                <div style="text-align: right; gap: 10px; display: flex; justify-content: flex-end;">
                    ${buttonHtml}
                </div>
            `;
            
            overlay.classList.add('show');
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            document.getElementById('modal-overlay').classList.remove('show');
        }

        // ä¿®ç‚¼åŠŸèƒ½
        function cultivate() {
            const char = gameData.character;
            const baseExp = 15 + char.level * 2;
            const expGain = Math.floor(baseExp * (0.8 + Math.random() * 0.4)); // 80%-120%å˜åŠ¨
            
            char.exp += expGain;
            char.day += 1;
            
            // æ¢å¤å°‘é‡ç”Ÿå‘½å€¼å’Œæ³•åŠ›å€¼
            char.hp = Math.min(char.maxHp, char.hp + Math.floor(char.maxHp * 0.05));
            char.mp = Math.min(char.maxMp, char.mp + Math.floor(char.maxMp * 0.1));
            
            addMessage(`ä¿®ç‚¼è·å¾— ${expGain} ç‚¹ä¿®ä¸º`, 'system');
            checkLevelUp();
            updateCharacterDisplay();
            updateQuestProgress('åˆå¿ƒè€…çš„ä¿®ç‚¼', 1);
            
            // æ›´æ–°ç»Ÿè®¡
            gameData.statistics.totalDamageDealt += expGain;
        }

        // è‡ªåŠ¨ä¿®ç‚¼ç›¸å…³
        function startAutoCultivation() {
            gameData.auto.cultivation = true;
            gameData.auto.startTime = Date.now();
            showNotification('å¼€å§‹è‡ªåŠ¨ä¿®ç‚¼ï¼ç¦»çº¿ä¹Ÿä¼šè·å¾—æ”¶ç›Š', 'success');
            updateAutoTimer();
        }

        function stopAutoCultivation() {
            gameData.auto.cultivation = false;
            gameData.auto.startTime = null;
            showNotification('åœæ­¢è‡ªåŠ¨ä¿®ç‚¼', 'warning');
            updateAutoTimer();
        }

        function updateAutoTimer() {
            const timerElement = document.getElementById('auto-timer');
            if (gameData.auto.cultivation) {
                const startTime = gameData.auto.startTime || Date.now();
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const hours = Math.floor(elapsed / 3600);
                const minutes = Math.floor((elapsed % 3600) / 60);
                const seconds = elapsed % 60;
                timerElement.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                timerElement.style.color = '#48bb78';
                setTimeout(updateAutoTimer, 1000);
            } else {
                timerElement.textContent = 'æœªå¼€å¯';
                timerElement.style.color = '#718096';
            }
        }

        // å†ç»ƒåŠŸèƒ½
        function adventure() {
            const char = gameData.character;
            const goldGain = Math.floor((10 + char.level * 2) * (0.8 + Math.random() * 0.4));
            char.gold += goldGain;
            char.day += 1;
            
            // éšæœºäº‹ä»¶
            const events = [
                { text: "å‘ç°äº†ä¸€ä¸ªå¤è€çš„æ´ç©´", bonus: 'exp', value: 20 },
                { text: "é‡åˆ°äº†å‹å–„çš„å•†äºº", bonus: 'gold', value: 20 },
                { text: "æ‰¾åˆ°äº†é—å¤±çš„å®ç®±", bonus: 'item', value: 'æ²»ç–—è¯æ°´' },
                { text: "å‡»è´¥äº†è·¯è¾¹çš„ç›—è´¼", bonus: 'exp', value: 30 },
                { text: "å¸®åŠ©äº†è¿·è·¯çš„æ‘æ°‘", bonus: 'gold', value: 15 }
            ];
            
            const event = events[Math.floor(Math.random() * events.length)];
            let bonusText = '';
            
            if (event.bonus === 'exp') {
                char.exp += event.value;
                bonusText = `ï¼Œé¢å¤–è·å¾— ${event.value} ä¿®ä¸º`;
            } else if (event.bonus === 'gold') {
                char.gold += event.value;
                bonusText = `ï¼Œé¢å¤–è·å¾— ${event.value} çµçŸ³`;
            } else if (event.bonus === 'item') {
                char.inventory[event.value] = (char.inventory[event.value] || 0) + 1;
                bonusText = `ï¼Œè·å¾— ${event.value} x1`;
            }
            
            addMessage(`å†ç»ƒä¸­${event.text}ï¼Œè·å¾— ${goldGain} çµçŸ³${bonusText}`, 'system');
            updateCharacterDisplay();
            updateInventory();
            updateQuestProgress('æ¢ç´¢è€…', 1);
        }

        // çªç ´åŠŸèƒ½
        function breakthrough() {
            attemptBreakthrough();
        }

        function attemptBreakthrough() {
            const char = gameData.character;
            const realm = CULTIVATION_REALMS[char.realmIndex];
            const expNeeded = char.level <= 9 ? CULTIVATION_LEVELS[realm][char.level - 1] : 0;
            
            if (char.exp < expNeeded) {
                showNotification('ä¿®ä¸ºä¸è¶³ï¼Œæ— æ³•çªç ´ï¼', 'error');
                return;
            }
            
            // è®¡ç®—æˆåŠŸç‡
            let successRate = 95 - (char.level - 1) * 5;
            if (char.level === 9) successRate = 70; // å¤§å¢ƒç•Œçªç ´æ›´éš¾
            successRate = Math.max(successRate, 20);
            
            const success = Math.random() * 100 < successRate;
            
            if (success) {
                char.exp -= expNeeded;
                char.level += 1;
                applyRealmUpgrade();
                
                showFloatingText(document.getElementById('char-realm'), 'çªç ´æˆåŠŸï¼', '#48bb78');
                addMessage(`æˆåŠŸçªç ´åˆ° ${realm} ${char.level}å±‚ï¼`, 'level');
                
                // å­¦ä¹ æ–°æŠ€èƒ½
                unlockSkillsAtLevel(char.level);
                
                // æ£€æŸ¥å¤§å¢ƒç•Œçªç ´
                if (char.level > 9 && char.realmIndex < CULTIVATION_REALMS.length - 1) {
                    char.realmIndex += 1;
                    char.level = 1;
                    const newRealm = CULTIVATION_REALMS[char.realmIndex];
                    applyRealmUpgrade();
                    
                    showAchievementPopup(`çªç ´åˆ° ${newRealm} å¢ƒç•Œï¼`, `æ­å–œï¼ä½ å·²ç»æ˜¯ ${newRealm} æœŸä¿®å£«äº†ï¼`);
                    addMessage(`ğŸ‰ æˆåŠŸçªç ´åˆ° ${newRealm} å¢ƒç•Œï¼å®åŠ›å¤§å¹…æå‡ï¼`, 'level');
                }
                
                updateAllDisplays();
            } else {
                char.exp -= Math.floor(expNeeded * 0.1); // å¤±è´¥æ¶ˆè€—10%ä¿®ä¸º
                showFloatingText(document.getElementById('char-realm'), 'çªç ´å¤±è´¥', '#e53e3e');
                addMessage('çªç ´å¤±è´¥ï¼ŒæŸå¤±éƒ¨åˆ†ä¿®ä¸º...', 'system');
                updateCharacterDisplay();
            }
        }

        // æ£€æŸ¥å‡çº§
        function checkLevelUp() {
            const char = gameData.character;
            const realm = CULTIVATION_REALMS[char.realmIndex];
            
            while (char.level <= 9) {
                const expNeeded = CULTIVATION_LEVELS[realm][char.level - 1];
                if (char.exp >= expNeeded) {
                    char.exp -= expNeeded;
                    char.level += 1;
                    applyRealmUpgrade();
                    
                    showFloatingText(document.getElementById('char-realm'), 'å‡çº§ï¼', '#ed8936');
                    addMessage(`å¢ƒç•Œæå‡åˆ° ${realm} ${char.level}å±‚ï¼`, 'level');
                    
                    // å­¦ä¹ æ–°æŠ€èƒ½
                    unlockSkillsAtLevel(char.level);
                    
                    // æ£€æŸ¥å¤§å¢ƒç•Œçªç ´
                    if (char.level > 9 && char.realmIndex < CULTIVATION_REALMS.length - 1) {
                        char.realmIndex += 1;
                        char.level = 1;
                        const newRealm = CULTIVATION_REALMS[char.realmIndex];
                        applyRealmUpgrade();
                        
                        showAchievementPopup(`çªç ´åˆ° ${newRealm} å¢ƒç•Œï¼`, `æ­å–œï¼ä½ å·²ç»æ˜¯ ${newRealm} æœŸä¿®å£«äº†ï¼`);
                        addMessage(`ğŸ‰ æˆåŠŸçªç ´åˆ° ${newRealm} å¢ƒç•Œï¼å®åŠ›å¤§å¹…æå‡ï¼`, 'level');
                        break;
                    }
                } else {
                    break;
                }
            }
            
            updateAllDisplays();
            checkAchievements();
        }

        // è§£é”æŠ€èƒ½
        function unlockSkillsAtLevel(level) {
            const char = gameData.character;
            for (const skill of char.skills) {
                const skillData = SKILL_DATA[skill.name];
                if (skillData && skillData.unlockLevel === level && !skill.unlocked) {
                    skill.unlocked = true;
                    addMessage(`é¢†æ‚Ÿäº†æ–°æŠ€èƒ½ï¼š${skill.name}ï¼`, 'level');
                    showNotification(`å­¦ä¼šæ–°æŠ€èƒ½ï¼š${skill.name}`, 'success');
                }
            }
            
            // æ·»åŠ æ–°æŠ€èƒ½
            for (const [skillName, skillData] of Object.entries(SKILL_DATA)) {
                if (skillData.unlockLevel === level && !char.skills.find(s => s.name === skillName)) {
                    char.skills.push({
                        name: skillName,
                        level: 1,
                        cooldown: 0,
                        maxCooldown: skillData.cooldown,
                        cost: skillData.cost,
                        type: skillData.element,
                        unlocked: true
                    });
                    addMessage(`é¢†æ‚Ÿäº†æ–°æŠ€èƒ½ï¼š${skillName}ï¼`, 'level');
                    showNotification(`å­¦ä¼šæ–°æŠ€èƒ½ï¼š${skillName}`, 'success');
                }
            }
        }

        // åº”ç”¨å¢ƒç•Œæå‡
        function applyRealmUpgrade() {
            const char = gameData.character;
            const realm = CULTIVATION_REALMS[char.realmIndex];
            const upgrade = REALM_UPGRADES[realm];
            
            for (const [stat, value] of Object.entries(upgrade)) {
                const randomBonus = Math.floor(value * (0.9 + Math.random() * 0.2)); // 90%-110%
                char[stat] += randomBonus;
                if (stat === 'hp') char.maxHp += randomBonus;
                if (stat === 'mp') char.maxMp += randomBonus;
            }
            
            // æ¢å¤æ»¡è¡€æ»¡è“
            char.hp = char.maxHp;
            char.mp = char.maxMp;
        }

        // æ›´æ–°èƒŒåŒ…
        function updateInventory() {
            const inventory = document.getElementById('inventory');
            inventory.innerHTML = '';
            
            for (const [itemName, count] of Object.entries(gameData.character.inventory)) {
                if (count > 0) {
                    const slot = document.createElement('div');
                    slot.className = 'inventory-slot occupied';
                    slot.onclick = () => useItem(itemName);
                    
                    const itemData = findItemData(itemName);
                    const icon = itemData?.icon || 'ğŸ“¦';
                    slot.innerHTML = `
                        <div class="item-icon">${icon}</div>
                        <div class="item-count">${count}</div>
                    `;
                    slot.title = `${itemName} x${count}\n${itemData?.description || ''}`;
                    inventory.appendChild(slot);
                }
            }
            
            // æ·»åŠ ç©ºæ§½ä½
            const totalSlots = 24;
            const usedSlots = Object.keys(gameData.character.inventory).filter(item => gameData.character.inventory[item] > 0).length;
            for (let i = usedSlots; i < totalSlots; i++) {
                const slot = document.createElement('div');
                slot.className = 'inventory-slot';
                inventory.appendChild(slot);
            }
        }

        // æŸ¥æ‰¾ç‰©å“æ•°æ®
        function findItemData(itemName) {
            for (const category of Object.values(SHOP_ITEMS)) {
                if (category[itemName]) {
                    return category[itemName];
                }
            }
            return null;
        }

        // ä½¿ç”¨ç‰©å“
        function useItem(itemName) {
            const char = gameData.character;
            if (!char.inventory[itemName] || char.inventory[itemName] <= 0) {
                showNotification('æ²¡æœ‰è¿™ä¸ªç‰©å“ï¼', 'error');
                return;
            }
            
            const itemData = findItemData(itemName);
            if (!itemData) {
                showNotification('æœªçŸ¥ç‰©å“ï¼', 'error');
                return;
            }
            
            switch(itemName) {
                case 'æ²»ç–—è¯æ°´':
                    const healAmount = Math.min(50, char.maxHp - char.hp);
                    char.hp += healAmount;
                    char.inventory[itemName] -= 1;
                    addMessage(`ä½¿ç”¨æ²»ç–—è¯æ°´ï¼Œæ¢å¤äº† ${healAmount} ç‚¹ç”Ÿå‘½å€¼`, 'system');
                    showFloatingText(document.getElementById('char-hp'), `+${healAmount}`, '#48bb78');
                    break;
                    
                case 'æ³•åŠ›è¯æ°´':
                    const mpAmount = Math.min(30, char.maxMp - char.mp);
                    char.mp += mpAmount;
                    char.inventory[itemName] -= 1;
                    addMessage(`ä½¿ç”¨æ³•åŠ›è¯æ°´ï¼Œæ¢å¤äº† ${mpAmount} ç‚¹æ³•åŠ›å€¼`, 'system');
                    showFloatingText(document.getElementById('char-mp'), `+${mpAmount}`, '#4299e1');
                    break;
                    
                case 'èšæ°”ä¸¹':
                    char.maxMp += 10;
                    char.mp += 10;
                    char.inventory[itemName] -= 1;
                    addMessage(`ä½¿ç”¨èšæ°”ä¸¹ï¼Œæ³•åŠ›ä¸Šé™æ°¸ä¹…å¢åŠ 10ç‚¹ï¼`, 'system');
                    break;
                    
                case 'å¼ºèº«ä¸¹':
                    char.maxHp += 20;
                    char.hp += 20;
                    char.inventory[itemName] -= 1;
                    addMessage(`ä½¿ç”¨å¼ºèº«ä¸¹ï¼Œç”Ÿå‘½ä¸Šé™æ°¸ä¹…å¢åŠ 20ç‚¹ï¼`, 'system');
                    break;
                    
                case 'æ‚Ÿé“èŒ¶':
                    char.exp += 200;
                    char.inventory[itemName] -= 1;
                    addMessage(`å“å°æ‚Ÿé“èŒ¶ï¼Œè·å¾—200ç‚¹ä¿®ä¸ºï¼`, 'system');
                    checkLevelUp();
                    break;
                    
                case 'å›æ˜¥ä¸¹':
                    char.hp = char.maxHp;
                    char.mp = char.maxMp;
                    char.inventory[itemName] -= 1;
                    addMessage(`ä½¿ç”¨å›æ˜¥ä¸¹ï¼Œå®Œå…¨æ¢å¤ç”Ÿå‘½å’Œæ³•åŠ›ï¼`, 'system');
                    break;
                    
                default:
                    // è£…å¤‡ç±»ç‰©å“
                    if (itemData.type === 'weapon' || itemData.type === 'armor' || itemData.type === 'accessory') {
                        equipItem(itemName, itemData);
                    }
                    break;
            }
            
            updateCharacterDisplay();
            updateInventory();
        }

        // è£…å¤‡ç‰©å“
        function equipItem(itemName, itemData) {
            const char = gameData.character;
            const equipSlot = itemData.type;
            
            // å¦‚æœå·²è£…å¤‡åŒç±»å‹ç‰©å“ï¼Œå…ˆå¸ä¸‹
            if (char.equipment[equipSlot]) {
                const oldItem = char.equipment[equipSlot];
                char.inventory[oldItem] = (char.inventory[oldItem] || 0) + 1;
                
                // ç§»é™¤æ—§è£…å¤‡å±æ€§
                const oldItemData = findItemData(oldItem);
                if (oldItemData && oldItemData.stats) {
                    for (const [stat, value] of Object.entries(oldItemData.stats)) {
                        char[stat] -= value;
                        if (stat === 'hp') char.maxHp -= value;
                        if (stat === 'mp') char.maxMp -= value;
                    }
                }
            }
            
            // è£…å¤‡æ–°ç‰©å“
            char.equipment[equipSlot] = itemName;
            char.inventory[itemName] -= 1;
            
            // åº”ç”¨æ–°è£…å¤‡å±æ€§
            if (itemData.stats) {
                for (const [stat, value] of Object.entries(itemData.stats)) {
                    char[stat] += value;
                    if (stat === 'hp') char.maxHp += value;
                    if (stat === 'mp') char.maxMp += value;
                }
            }
            
            addMessage(`è£…å¤‡ ${itemName}ï¼`, 'system');
            updateEquipment();
        }

        // æ›´æ–°æŠ€èƒ½åˆ—è¡¨
        function updateSkillList() {
            const skillList = document.getElementById('skill-display-list');
            skillList.innerHTML = '';
            
            gameData.character.skills.forEach(skill => {
                const skillData = SKILL_DATA[skill.name];
                if (!skillData) return;
                
                const skillDiv = document.createElement('div');
                skillDiv.className = `skill-card ${(!skill.unlocked && skill.name !== 'æ™®é€šæ”»å‡»') ? 'disabled' : ''}`;
                
                if (skill.unlocked || skill.name === 'æ™®é€šæ”»å‡»') {
                    skillDiv.onclick = () => showSkillDetails(skill);
                }
                
                const cooldownDisplay = skill.cooldown > 0 ? 
                    `<div class="skill-cooldown">${skill.cooldown}</div>` : '';
                
                skillDiv.innerHTML = `
                    ${cooldownDisplay}
                    <h4>âœ¨ ${skill.name} (Lv.${skill.level})</h4>
                    <p>${skillData.description}</p>
                    <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                        <span>æ¶ˆè€—: ${skillData.cost} MP</span>
                        <span>å†·å´: ${skillData.cooldown}å›åˆ</span>
                    </div>
                    <div style="color: #666; font-size: 12px; margin-top: 5px;">
                        å±æ€§: ${skillData.element} | å¨åŠ›: ${(skillData.power * 100).toFixed(0)}%
                    </div>
                `;
                skillList.appendChild(skillDiv);
            });
        }

        // æ˜¾ç¤ºæŠ€èƒ½è¯¦æƒ…
        function showSkillDetails(skill) {
            const skillData = SKILL_DATA[skill.name];
            showModal(`${skill.name} è¯¦æƒ…`, `
                <p><strong>ç­‰çº§:</strong> ${skill.level}</p>
                <p><strong>æè¿°:</strong> ${skillData.description}</p>
                <p><strong>æ³•åŠ›æ¶ˆè€—:</strong> ${skillData.cost}</p>
                <p><strong>å†·å´æ—¶é—´:</strong> ${skillData.cooldown} å›åˆ</p>
                <p><strong>å±æ€§:</strong> ${skillData.element}</p>
                <p><strong>å¨åŠ›:</strong> ${(skillData.power * 100).toFixed(0)}%</p>
                <hr>
                <p>å‡çº§æ‰€éœ€: ${skill.level * 100} çµçŸ³</p>
            `, [
                { text: 'å‡çº§æŠ€èƒ½', class: 'btn-primary', onclick: `upgradeSkill('${skill.name}')` },
                { text: 'å…³é—­', class: 'btn-primary', onclick: 'closeModal()' }
            ]);
        }

        // å‡çº§æŠ€èƒ½
        function upgradeSkill(skillName) {
            const char = gameData.character;
            const skill = char.skills.find(s => s.name === skillName);
            if (!skill) return;
            
            const cost = skill.level * 100;
            if (char.gold >= cost) {
                char.gold -= cost;
                skill.level += 1;
                addMessage(`${skillName} å‡çº§åˆ° ${skill.level} çº§ï¼`, 'system');
                showNotification(`${skillName} å‡çº§æˆåŠŸï¼`, 'success');
                closeModal();
                updateAllDisplays();
            } else {
                showNotification('çµçŸ³ä¸è¶³ï¼', 'error');
            }
        }

        // æ›´æ–°è£…å¤‡
        function updateEquipment() {
            const equipment = gameData.character.equipment;
            document.getElementById('weapon-slot').textContent = equipment.weapon || 'æ— ';
            document.getElementById('armor-slot').textContent = equipment.armor || 'æ— ';
            document.getElementById('accessory-slot').textContent = equipment.accessory || 'æ— ';
            document.getElementById('technique-slot').textContent = equipment.technique || 'åŸºç¡€åçº³æœ¯';
        }

        // åœ°å›¾ç³»ç»Ÿ
        function switchMap(mapName) {
            gameData.currentMap = mapName;
            gameData.character.position = { x: 4, y: 4, map: mapName };
            
            // æ›´æ–°åœ°å›¾é€‰æ‹©æ ·å¼
            document.querySelectorAll('[id^="map-"]').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`map-${mapName}`).classList.add('active');
            
            // æ›´æ–°åœ°å›¾ä¿¡æ¯
            const mapData = gameData.maps[mapName];
            document.getElementById('current-map-name').textContent = mapData.name;
            document.getElementById('current-map-desc').textContent = mapData.desc;
            
            generateMap();
        }

        function generateMap() {
            const mapGrid = document.getElementById('map-grid');
            const mapData = gameData.maps[gameData.currentMap];
            mapGrid.innerHTML = '';
            
            // è®¾ç½®ç½‘æ ¼å¤§å°
            mapGrid.style.gridTemplateColumns = `repeat(${mapData.size}, 1fr)`;
            
            for (let y = 0; y < mapData.size; y++) {
                for (let x = 0; x < mapData.size; x++) {
                    const tile = document.createElement('div');
                    tile.className = 'map-tile';
                    tile.onclick = () => moveToTile(x, y);
                    
                    if (x === gameData.character.position.x && y === gameData.character.position.y) {
                        tile.classList.add('player');
                        tile.textContent = 'ğŸ§™';
                    } else {
                        // æ ¹æ®åœ°å›¾ç±»å‹ç”Ÿæˆä¸åŒå†…å®¹
                        const rand = Math.random();
                        if (rand < 0.15) {
                            tile.classList.add('enemy');
                            tile.textContent = 'ğŸ‘¹';
                        } else if (rand < 0.25) {
                            tile.classList.add('treasure');
                            tile.textContent = 'ğŸ’°';
                        } else if ((x === 0 && y === 0) || (x === mapData.size-1 && y === mapData.size-1)) {
                            tile.classList.add('town');
                            tile.textContent = 'ğŸ˜ï¸';
                        } else if (rand < 0.28 && gameData.currentMap !== 'newbie') {
                            tile.classList.add('boss');
                            tile.textContent = 'ğŸ‰';
                        } else {
                            // æ ¹æ®åœ°å›¾è®¾ç½®ä¸åŒåœ°å½¢
                            const terrains = {
                                'newbie': 'ğŸŒ±',
                                'forest': 'ğŸŒ²',
                                'mountain': 'â›°ï¸',
                                'ruins': 'ğŸ›ï¸'
                            };
                            tile.textContent = terrains[gameData.currentMap] || 'ğŸŒ¿';
                        }
                    }
                    
                    mapGrid.appendChild(tile);
                }
            }
        }

        function moveToTile(x, y) {
            const pos = gameData.character.position;
            const mapData = gameData.maps[gameData.currentMap];
            
            // æ£€æŸ¥æ˜¯å¦ç›¸é‚»
            if (Math.abs(x - pos.x) + Math.abs(y - pos.y) !== 1) {
                showNotification('åªèƒ½ç§»åŠ¨åˆ°ç›¸é‚»çš„æ ¼å­ï¼', 'warning');
                return;
            }
            
            // æ£€æŸ¥è¡ŒåŠ¨ç‚¹
            if (gameData.character.actionPoints <= 0) {
                showNotification('è¡ŒåŠ¨ç‚¹ä¸è¶³ï¼è¯·ä¼‘æ¯æ¢å¤', 'error');
                return;
            }
            
            gameData.character.actionPoints -= 1;
            gameData.character.position = { x, y, map: gameData.currentMap };
            
            // è§¦å‘äº‹ä»¶
            const tileIndex = y * mapData.size + x;
            const tile = document.querySelectorAll('.map-tile')[tileIndex];
            
            if (tile.classList.contains('enemy')) {
                const enemyTypes = ['bandit', 'beast'];
                if (gameData.currentMap !== 'newbie') enemyTypes.push('demon');
                const randomType = enemyTypes[Math.floor(Math.random() * enemyTypes.length)];
                selectEnemy(randomType);
                switchTab('battle');
                startBattle();
            } else if (tile.classList.contains('treasure')) {
                discoverTreasure();
            } else if (tile.classList.contains('town')) {
                enterTown();
            } else if (tile.classList.contains('boss')) {
                selectEnemy('boss');
                switchTab('battle');
                showNotification('é­é‡å¼ºå¤§çš„BOSSï¼', 'warning');
            }
            
            generateMap();
            updateQuestProgress('æ¢ç´¢è€…', 1);
        }

        function discoverTreasure() {
            const treasures = [
                { type: 'gold', value: 100 + Math.floor(Math.random() * 200) },
                { type: 'exp', value: 50 + Math.floor(Math.random() * 100) },
                { type: 'item', value: 'æ²»ç–—è¯æ°´', count: 2 },
                { type: 'item', value: 'æ³•åŠ›è¯æ°´', count: 3 },
                { type: 'equipment', value: 'é’é¾™å‰‘' }
            ];
            
            const treasure = treasures[Math.floor(Math.random() * treasures.length)];
            let message = 'å‘ç°å®è—ï¼';
            
            if (treasure.type === 'gold') {
                gameData.character.gold += treasure.value;
                message += `è·å¾— ${treasure.value} çµçŸ³`;
            } else if (treasure.type === 'exp') {
                gameData.character.exp += treasure.value;
                message += `è·å¾— ${treasure.value} ä¿®ä¸º`;
                checkLevelUp();
            } else if (treasure.type === 'item') {
                gameData.character.inventory[treasure.value] = 
                    (gameData.character.inventory[treasure.value] || 0) + (treasure.count || 1);
                message += `è·å¾— ${treasure.value} x${treasure.count || 1}`;
            }
            
            addMessage(message, 'system');
            updateAllDisplays();
        }

        function enterTown() {
            // æ¢å¤è¡ŒåŠ¨ç‚¹å’Œå°‘é‡ç”Ÿå‘½æ³•åŠ›
            gameData.character.actionPoints = gameData.character.maxActionPoints;
            gameData.character.hp = Math.min(gameData.character.maxHp, gameData.character.hp + 20);
            gameData.character.mp = Math.min(gameData.character.maxMp, gameData.character.mp + 15);
            
            addMessage('è¿›å…¥åŸé•‡ï¼Œæ¢å¤äº†ä½“åŠ›å’Œè¡ŒåŠ¨ç‚¹', 'system');
            switchTab('shop');
            updateCharacterDisplay();
        }

        // å•†åº—ç³»ç»Ÿ
        function updateShop() {
            const shopItems = document.getElementById('shop-items');
            shopItems.innerHTML = '';
            
            const items = SHOP_ITEMS[currentShopTab] || {};
            
            for (const [itemName, item] of Object.entries(items)) {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'skill-card';
                itemDiv.onclick = () => buyItem(itemName);
                
                itemDiv.innerHTML = `
                    <h4>${item.icon} ${itemName}</h4>
                    <p>${item.description}</p>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                        <span style="color: #ed8936; font-weight: bold;">${item.price.toLocaleString()} çµçŸ³</span>
                        <button class="btn btn-primary" onclick="event.stopPropagation(); buyItem('${itemName}')">è´­ä¹°</button>
                    </div>
                `;
                shopItems.appendChild(itemDiv);
            }
        }

        function buyItem(itemName) {
            const item = SHOP_ITEMS[currentShopTab][itemName];
            const char = gameData.character;
            
            if (!item) {
                showNotification('å•†å“ä¸å­˜åœ¨ï¼', 'error');
                return;
            }
            
            if (char.gold >= item.price) {
                char.gold -= item.price;
                
                if (item.type === 'technique') {
                    if (!char.techniques.includes(itemName)) {
                        char.techniques.push(itemName);
                        addMessage(`å­¦ä¼šäº†åŠŸæ³•ï¼š${itemName}`, 'system');
                    } else {
                        showNotification('å·²ç»å­¦ä¼šäº†è¿™ä¸ªåŠŸæ³•ï¼', 'warning');
                        char.gold += item.price; // é€€è¿˜çµçŸ³
                        return;
                    }
                } else {
                    char.inventory[itemName] = (char.inventory[itemName] || 0) + 1;
                }
                
                addMessage(`è´­ä¹°äº† ${itemName}`, 'system');
                showNotification(`æˆåŠŸè´­ä¹° ${itemName}ï¼`, 'success');
                updateAllDisplays();
            } else {
                showNotification('çµçŸ³ä¸è¶³ï¼', 'error');
            }
        }

        // ä»»åŠ¡ç³»ç»Ÿ
        function updateQuests() {
            const questList = document.getElementById('quest-list');
            questList.innerHTML = '';
            
            gameData.quests.forEach(quest => {
                const questDiv = document.createElement('div');
                questDiv.className = 'skill-card';
                
                const progressPercent = Math.min((quest.progress / quest.target) * 100, 100);
                const isCompleted = quest.progress >= quest.target && !quest.completed;
                
                questDiv.innerHTML = `
                    <h4>${quest.name} ${quest.completed ? 'âœ…' : ''}</h4>
                    <p>${quest.description}</p>
                    <div style="margin: 10px 0;">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progressPercent}%"></div>
                        </div>
                        <small style="display: flex; justify-content: space-between; margin-top: 5px;">
                            <span>${quest.progress}/${quest.target}</span>
                            <span>${progressPercent.toFixed(1)}%</span>
                        </small>
                    </div>
                    <div style="color: #48bb78; font-weight: bold;">
                        å¥–åŠ±: ${quest.reward.gold ? quest.reward.gold + ' çµçŸ³ ' : ''}
                        ${quest.reward.exp ? quest.reward.exp + ' ä¿®ä¸º ' : ''}
                        ${quest.reward.item ? quest.reward.item : ''}
                    </div>
                    ${isCompleted ? '<button class="btn btn-success" onclick="completeQuest(' + quest.id + ')" style="width: 100%; margin-top: 10px;">é¢†å–å¥–åŠ±</button>' : ''}
                `;
                
                questList.appendChild(questDiv);
            });
        }

        function updateQuestProgress(questName, amount) {
            const quest = gameData.quests.find(q => q.name === questName);
            if (quest && !quest.completed) {
                quest.progress = Math.min(quest.target, quest.progress + amount);
                updateQuests();
                
                if (quest.progress >= quest.target) {
                    showNotification(`ä»»åŠ¡å®Œæˆï¼š${quest.name}ï¼`, 'success');
                }
            }
        }

        function completeQuest(questId) {
            const quest = gameData.quests.find(q => q.id === questId);
            if (quest && quest.progress >= quest.target && !quest.completed) {
                quest.completed = true;
                
                if (quest.reward.gold) {
                    gameData.character.gold += quest.reward.gold;
                }
                if (quest.reward.exp) {
                    gameData.character.exp += quest.reward.exp;
                    checkLevelUp();
                }
                if (quest.reward.item) {
                    gameData.character.inventory[quest.reward.item] = 
                        (gameData.character.inventory[quest.reward.item] || 0) + 1;
                }
                
                gameData.statistics.questsCompleted += 1;
                addMessage(`å®Œæˆä»»åŠ¡ï¼š${quest.name}ï¼`, 'quest');
                showNotification(`ä»»åŠ¡å®Œæˆï¼š${quest.name}ï¼`, 'success');
                updateAllDisplays();
                checkAchievements();
            }
        }

        // æˆå°±ç³»ç»Ÿ
        function updateAchievements() {
            const achievementList = document.getElementById('achievement-list');
            achievementList.innerHTML = '';
            
            gameData.achievements.forEach(achievement => {
                const achievementDiv = document.createElement('div');
                achievementDiv.className = `skill-card ${achievement.unlocked ? '' : 'disabled'}`;
                
                let progress = '';
                const char = gameData.character;
                const stats = gameData.statistics;
                
                switch(achievement.condition.type) {
                    case 'level':
                        progress = `${char.level}/${achievement.condition.value}`;
                        break;
                    case 'battles_won':
                        progress = `${stats.battlesWon}/${achievement.condition.value}`;
                        break;
                    case 'gold':
                        progress = `${char.gold}/${achievement.condition.value}`;
                        break;
                }
                
                achievementDiv.innerHTML = `
                    <h4>ğŸ† ${achievement.name} ${achievement.unlocked ? 'âœ…' : ''}</h4>
                    <p>${achievement.description}</p>
                    <div style="margin-top: 10px;">
                        <small>è¿›åº¦: ${progress}</small>
                    </div>
                    <div style="color: #ed8936; font-weight: bold; margin-top: 5px;">
                        å¥–åŠ±: ${achievement.reward.gold ? achievement.reward.gold + ' çµçŸ³ ' : ''}
                        ${achievement.reward.exp ? achievement.reward.exp + ' ä¿®ä¸º' : ''}
                    </div>
                `;
                
                achievementList.appendChild(achievementDiv);
            });
        }

        function checkAchievements() {
            const char = gameData.character;
            const stats = gameData.statistics;
            
            gameData.achievements.forEach(achievement => {
                if (achievement.unlocked) return;
                
                let completed = false;
                switch(achievement.condition.type) {
                    case 'level':
                        completed = char.level >= achievement.condition.value;
                        break;
                    case 'battles_won':
                        completed = stats.battlesWon >= achievement.condition.value;
                        break;
                    case 'gold':
                        completed = char.gold >= achievement.condition.value;
                        break;
                }
                
                if (completed) {
                    achievement.unlocked = true;
                    
                    if (achievement.reward.gold) {
                        char.gold += achievement.reward.gold;
                    }
                    if (achievement.reward.exp) {
                        char.exp += achievement.reward.exp;
                        checkLevelUp();
                    }
                    
                    showAchievementPopup(achievement.name, achievement.description);
                    addMessage(`è§£é”æˆå°±ï¼š${achievement.name}ï¼`, 'quest');
                }
            });
            
            updateAchievements();
        }

        // æ›´æ–°ç»Ÿè®¡
        function updateStatistics() {
            const stats = gameData.statistics;
            document.getElementById('days-count').textContent = gameData.character.day;
            document.getElementById('battles-won').textContent = stats.battlesWon;
            document.getElementById('enemies-defeated').textContent = stats.enemiesDefeated;
            document.getElementById('quests-completed').textContent = stats.questsCompleted;
        }

        // æˆ˜æ–—ç³»ç»Ÿå¢å¼º
        let battleTurn = 0;

        function selectEnemy(enemyType) {
            currentEnemy = JSON.parse(JSON.stringify(ENEMIES[enemyType])); // æ·±æ‹·è´
            currentEnemy.maxHp = currentEnemy.hp;
            currentEnemy.mp = 50; // ç»™æ•Œäººä¸€äº›æ³•åŠ›å€¼
            currentEnemy.maxMp = 50;
            
            // æ ¹æ®ç©å®¶ç­‰çº§è°ƒæ•´æ•Œäººå¼ºåº¦
            const playerLevel = gameData.character.level + gameData.character.realmIndex * 10;
            const levelDiff = Math.max(0, playerLevel - currentEnemy.level);
            const multiplier = 1 + levelDiff * 0.1;
            
            currentEnemy.hp = Math.floor(currentEnemy.hp * multiplier);
            currentEnemy.maxHp = currentEnemy.hp;
            currentEnemy.attack = Math.floor(currentEnemy.attack * multiplier);
            currentEnemy.defense = Math.floor(currentEnemy.defense * multiplier);
            
            document.getElementById('enemy-name').textContent = currentEnemy.name;
            document.getElementById('enemy-level').textContent = currentEnemy.level;
            updateBattleDisplay();
        }

        function updateBattleDisplay() {
            const char = gameData.character;
            document.getElementById('player-name').textContent = char.name;
            document.getElementById('player-level').textContent = char.level;
            
            const playerHpPercent = (char.hp / char.maxHp) * 100;
            document.getElementById('player-hp-bar').style.width = playerHpPercent + '%';
            document.getElementById('player-hp-bar').textContent = `${char.hp}/${char.maxHp}`;
            
            const playerMpPercent = (char.mp / char.maxMp) * 100;
            document.getElementById('player-mp-bar').style.width = playerMpPercent + '%';
            document.getElementById('player-mp-bar').textContent = `${char.mp}/${char.maxMp}`;
            
            if (currentEnemy) {
                const enemyHpPercent = (currentEnemy.hp / currentEnemy.maxHp) * 100;
                document.getElementById('enemy-hp-bar').style.width = enemyHpPercent + '%';
                document.getElementById('enemy-hp-bar').textContent = `${currentEnemy.hp}/${currentEnemy.maxHp}`;
                
                document.getElementById('enemy-card').querySelector('.character-avatar').textContent = currentEnemy.icon;
            }
        }

        function startBattle() {
            if (!currentEnemy) {
                showNotification('è¯·å…ˆé€‰æ‹©å¯¹æ‰‹ï¼', 'warning');
                return;
            }
            
            gameData.battle.inBattle = true;
            gameData.battle.enemy = currentEnemy;
            gameData.battle.playerTurn = true;
            gameData.battle.round = 0;
            battleTurn = 0;
            
            // é‡ç½®æŠ€èƒ½å†·å´
            gameData.character.skills.forEach(skill => skill.cooldown = 0);
            
            document.getElementById('start-battle-btn').style.display = 'none';
            document.getElementById('battle-actions').style.display = 'block';
            
            addMessage(`å¼€å§‹ä¸ ${currentEnemy.name} æˆ˜æ–—ï¼`, 'battle');
            updateBattleDisplay();
        }

        function normalAttack() {
            if (!gameData.battle.inBattle || !gameData.battle.playerTurn) return;
            
            const char = gameData.character;
            const enemy = gameData.battle.enemy;
            
            // è®¡ç®—ä¼¤å®³
            let damage = Math.max(1, char.attack - enemy.defense + Math.floor(Math.random() * 11) - 5);
            
            // æš´å‡»è®¡ç®—
            const isCritical = Math.random() * 100 < char.critRate;
            if (isCritical) {
                damage = Math.floor(damage * 2);
                addMessage(`æš´å‡»ï¼å¯¹ ${enemy.name} é€ æˆäº† ${damage} ç‚¹ä¼¤å®³`, 'battle');
                showFloatingDamage(document.getElementById('enemy-card'), damage, true);
            } else {
                addMessage(`å¯¹ ${enemy.name} é€ æˆäº† ${damage} ç‚¹ä¼¤å®³`, 'battle');
                showFloatingDamage(document.getElementById('enemy-card'), damage, false);
            }
            
            enemy.hp -= damage;
            gameData.statistics.totalDamageDealt += damage;
            
            if (enemy.hp <= 0) {
                winBattle();
            } else {
                endPlayerTurn();
            }
            
            updateBattleDisplay();
        }

        function showSkillsInBattle() {
            const char = gameData.character;
            const availableSkills = char.skills.filter(skill => 
                skill.unlocked && skill.cooldown === 0 && char.mp >= skill.cost
            );
            
            if (availableSkills.length === 0) {
                showNotification('æ²¡æœ‰å¯ç”¨çš„æŠ€èƒ½ï¼', 'warning');
                return;
            }
            
            let skillsHtml = '<h3>é€‰æ‹©æŠ€èƒ½</h3><div class="skill-list">';
            availableSkills.forEach(skill => {
                const skillData = SKILL_DATA[skill.name];
                skillsHtml += `
                    <div class="skill-card" onclick="useSkillInBattle('${skill.name}')">
                        <h4>${skill.name}</h4>
                        <p>${skillData.description}</p>
                        <small>æ¶ˆè€—: ${skillData.cost} MP</small>
                    </div>
                `;
            });
            skillsHtml += '</div>';
            
            showModal('ä½¿ç”¨æŠ€èƒ½', skillsHtml);
        }

        function useSkillInBattle(skillName) {
            closeModal();
            
            const char = gameData.character;
            const skill = char.skills.find(s => s.name === skillName);
            const skillData = SKILL_DATA[skillName];
            const enemy = gameData.battle.enemy;
            
            if (!skill || skill.cooldown > 0 || char.mp < skillData.cost) {
                showNotification('æ— æ³•ä½¿ç”¨è¯¥æŠ€èƒ½ï¼', 'error');
                return;
            }
            
            char.mp -= skillData.cost;
            skill.cooldown = skillData.cooldown;
            
            switch(skillData.effect) {
                case 'damage':
                    let damage = Math.floor((char.attack * skillData.power) - enemy.defense + Math.floor(Math.random() * 11) - 5);
                    damage = Math.max(1, damage);
                    
                    // å±æ€§ç›¸å…‹åŠ æˆ
                    if (char.spiritualRoot.type === skillData.element) {
                        damage = Math.floor(damage * 1.2);
                    }
                    
                    enemy.hp -= damage;
                    addMessage(`ä½¿ç”¨ ${skillName}ï¼Œå¯¹ ${enemy.name} é€ æˆäº† ${damage} ç‚¹ä¼¤å®³`, 'battle');
                    showFloatingDamage(document.getElementById('enemy-card'), damage, false);
                    gameData.statistics.totalDamageDealt += damage;
                    break;
                    
                case 'heal':
                    const healAmount = Math.floor(char.maxHp * skillData.power);
                    char.hp = Math.min(char.maxHp, char.hp + healAmount);
                    addMessage(`ä½¿ç”¨ ${skillName}ï¼Œæ¢å¤äº† ${healAmount} ç‚¹ç”Ÿå‘½å€¼`, 'battle');
                    showFloatingText(document.getElementById('player-card'), `+${healAmount}`, '#48bb78');
                    break;
                    
                case 'buff_defense':
                    const buffAmount = Math.floor(char.defense * skillData.power);
                    char.defense += buffAmount;
                    addMessage(`ä½¿ç”¨ ${skillName}ï¼Œé˜²å¾¡åŠ›æå‡ ${buffAmount} ç‚¹`, 'battle');
                    break;
            }
            
            if (enemy.hp <= 0) {
                winBattle();
            } else {
                endPlayerTurn();
            }
            
            updateBattleDisplay();
        }

        function showItemsInBattle() {
            const char = gameData.character;
            const usableItems = ['æ²»ç–—è¯æ°´', 'æ³•åŠ›è¯æ°´', 'å›æ˜¥ä¸¹'];
            const availableItems = usableItems.filter(item => char.inventory[item] > 0);
            
            if (availableItems.length === 0) {
                showNotification('æ²¡æœ‰å¯ç”¨çš„ç‰©å“ï¼', 'warning');
                return;
            }
            
            let itemsHtml = '<h3>é€‰æ‹©ç‰©å“</h3><div class="skill-list">';
            availableItems.forEach(itemName => {
                const itemData = findItemData(itemName);
                itemsHtml += `
                    <div class="skill-card" onclick="useItemInBattle('${itemName}')">
                        <h4>${itemData.icon} ${itemName}</h4>
                        <p>${itemData.description}</p>
                        <small>æ•°é‡: ${char.inventory[itemName]}</small>
                    </div>
                `;
            });
            itemsHtml += '</div>';
            
            showModal('ä½¿ç”¨ç‰©å“', itemsHtml);
        }

        function useItemInBattle(itemName) {
            closeModal();
            useItem(itemName);
            endPlayerTurn();
        }

        function defend() {
            if (!gameData.battle.inBattle || !gameData.battle.playerTurn) return;
            
            gameData.battle.playerDefending = true;
            addMessage('è¿›å…¥é˜²å¾¡å§¿æ€ï¼Œå‡å°‘50%ä¼¤å®³', 'battle');
            endPlayerTurn();
        }

        function escapeBattle() {
            const escapeChance = Math.max(20, 80 - (currentEnemy.level - gameData.character.level) * 10);
            
            if (Math.random() * 100 < escapeChance) {
                addMessage('æˆåŠŸé€ƒè„±æˆ˜æ–—ï¼', 'battle');
                endBattle();
            } else {
                addMessage('é€ƒè„±å¤±è´¥ï¼', 'battle');
                endPlayerTurn();
            }
        }

        function endPlayerTurn() {
            gameData.battle.playerTurn = false;
            battleTurn++;
            
            // å‡å°‘æŠ€èƒ½å†·å´
            gameData.character.skills.forEach(skill => {
                if (skill.cooldown > 0) skill.cooldown--;
            });
            
            setTimeout(enemyTurn, 1500);
        }

        function enemyTurn() {
            if (!gameData.battle.inBattle) return;
            
            const char = gameData.character;
            const enemy = gameData.battle.enemy;
            
            // æ•ŒäººAIé€‰æ‹©è¡ŒåŠ¨
            let action = 'attack';
            if (enemy.skills && enemy.skills.length > 1 && Math.random() < 0.3) {
                action = 'skill';
            }
            
            if (action === 'attack') {
                let damage = Math.max(1, enemy.attack - char.defense + Math.floor(Math.random() * 11) - 5);
                
                if (gameData.battle.playerDefending) {
                    damage = Math.floor(damage * 0.5);
                    gameData.battle.playerDefending = false;
                }
                
                char.hp -= damage;
                gameData.statistics.totalDamageTaken += damage;
                addMessage(`${enemy.name} æ”»å‡»ä½ ï¼Œé€ æˆäº† ${damage} ç‚¹ä¼¤å®³`, 'battle');
                showFloatingDamage(document.getElementById('player-card'), damage, false);
            } else if (action === 'skill') {
                // æ•Œäººä½¿ç”¨æŠ€èƒ½
                const skillName = enemy.skills[Math.floor(Math.random() * enemy.skills.length)];
                let skillDamage = Math.floor(enemy.attack * 1.3);
                char.hp -= skillDamage;
                addMessage(`${enemy.name} ä½¿ç”¨ ${skillName}ï¼Œå¯¹ä½ é€ æˆäº† ${skillDamage} ç‚¹ä¼¤å®³`, 'battle');
                showFloatingDamage(document.getElementById('player-card'), skillDamage, false);
            }
            
            if (char.hp <= 0) {
                loseBattle();
            } else {
                gameData.battle.playerTurn = true;
            }
            
            updateBattleDisplay();
        }

        function winBattle() {
            const enemy = gameData.battle.enemy;
            const char = gameData.character;
            
            // è®¡ç®—å¥–åŠ±
            let goldReward = enemy.reward.gold;
            let expReward = enemy.reward.exp;
            
            // ç­‰çº§å·®å¥–åŠ±åŠ æˆ
            const levelDiff = Math.max(0, enemy.level - (char.level + char.realmIndex * 10));
            const bonusMultiplier = 1 + levelDiff * 0.1;
            
            goldReward = Math.floor(goldReward * bonusMultiplier);
            expReward = Math.floor(expReward * bonusMultiplier);
            
            char.gold += goldReward;
            char.exp += expReward;
            
            gameData.statistics.battlesWon += 1;
            gameData.statistics.enemiesDefeated += 1;
            
            addMessage(`æˆ˜æ–—èƒœåˆ©ï¼è·å¾— ${goldReward} çµçŸ³å’Œ ${expReward} ä¿®ä¸º`, 'battle');
            showNotification('æˆ˜æ–—èƒœåˆ©ï¼', 'success');
            
            // éšæœºæ‰è½ç‰©å“
            if (Math.random() < 0.3) {
                const dropItems = ['æ²»ç–—è¯æ°´', 'æ³•åŠ›è¯æ°´', 'èšæ°”ä¸¹'];
                const dropItem = dropItems[Math.floor(Math.random() * dropItems.length)];
                char.inventory[dropItem] = (char.inventory[dropItem] || 0) + 1;
                addMessage(`é¢å¤–è·å¾—æˆ˜åˆ©å“ï¼š${dropItem}`, 'battle');
            }
            
            // æ›´æ–°ä»»åŠ¡è¿›åº¦
            if (enemy.name.includes('å¼ºç›—')) {
                updateQuestProgress('æˆ˜èƒœå¼ºç›—', 1);
            }
            
            checkLevelUp();
            endBattle();
        }

        function loseBattle() {
            const char = gameData.character;
            char.hp = Math.floor(char.maxHp * 0.1); // ä¿ç•™10%ç”Ÿå‘½å€¼
            
            // æŸå¤±ä¸€äº›çµçŸ³
            const goldLoss = Math.floor(char.gold * 0.05);
            char.gold = Math.max(0, char.gold - goldLoss);
            
            addMessage(`æˆ˜æ–—å¤±è´¥ï¼é‡ä¼¤é€ƒè„±ï¼ŒæŸå¤± ${goldLoss} çµçŸ³`, 'battle');
            showNotification('æˆ˜æ–—å¤±è´¥ï¼', 'error');
            endBattle();
        }

        function endBattle() {
            gameData.battle.inBattle = false;
            gameData.battle.enemy = null;
            gameData.battle.playerTurn = true;
            currentEnemy = null;
            
            document.getElementById('start-battle-btn').style.display = 'block';
            document.getElementById('battle-actions').style.display = 'none';
            
            document.getElementById('enemy-name').textContent = 'é€‰æ‹©å¯¹æ‰‹';
            document.getElementById('enemy-level').textContent = '--';
            document.getElementById('enemy-hp-bar').style.width = '100%';
            document.getElementById('enemy-hp-bar').textContent = '--/--';
            document.getElementById('enemy-card').querySelector('.character-avatar').textContent = 'â“';
            
            updateCharacterDisplay();
        }

        function randomBattle() {
            const enemyTypes = ['bandit', 'beast'];
            if (gameData.character.level > 5) enemyTypes.push('demon');
            if (gameData.character.level > 20) enemyTypes.push('boss');
            
            const randomType = enemyTypes[Math.floor(Math.random() * enemyTypes.length)];
            selectEnemy(randomType);
            switchTab('battle');
            setTimeout(() => startBattle(), 500);
        }

        // ç‰¹æ•ˆå‡½æ•°
        function showFloatingText(element, text, color) {
            const floating = document.createElement('div');
            floating.className = 'floating-damage';
            floating.textContent = text;
            floating.style.color = color;
            floating.style.left = (element.offsetLeft + element.offsetWidth / 2) + 'px';
            floating.style.top = (element.offsetTop + element.offsetHeight / 2) + 'px';
            
            element.parentNode.appendChild(floating);
            setTimeout(() => {
                if (floating.parentNode) {
                    floating.parentNode.removeChild(floating);
                }
            }, 2000);
        }

        function showFloatingDamage(element, damage, isCritical) {
            const floating = document.createElement('div');
            floating.className = `floating-damage ${isCritical ? 'critical-hit' : ''}`;
            floating.textContent = `-${damage}`;
            floating.style.color = isCritical ? '#e53e3e' : '#f56565';
            floating.style.left = (element.offsetLeft + element.offsetWidth / 2) + 'px';
            floating.style.top = (element.offsetTop + element.offsetHeight / 2) + 'px';
            
            element.parentNode.appendChild(floating);
            setTimeout(() => {
                if (floating.parentNode) {
                    floating.parentNode.removeChild(floating);
                }
            }, 2000);
        }

        function showAchievementPopup(title, description) {
            const popup = document.createElement('div');
            popup.className = 'achievement-popup';
            popup.innerHTML = `
                <h2>ğŸ† æˆå°±è§£é”ï¼</h2>
                <h3>${title}</h3>
                <p>${description}</p>
                <button class="btn btn-primary" onclick="this.parentNode.remove()">ç¡®å®š</button>
            `;
            
            document.body.appendChild(popup);
            setTimeout(() => popup.classList.add('show'), 100);
            setTimeout(() => {
                popup.classList.remove('show');
                setTimeout(() => {
                    if (popup.parentNode) {
                        document.body.removeChild(popup);
                    }
                }, 300);
            }, 5000);
        }

        // è®¾ç½®ç³»ç»Ÿ
        function showSettings() {
            const settings = gameData.settings;
            showModal('æ¸¸æˆè®¾ç½®', `
                <div>
                    <label>
                        <input type="checkbox" ${settings.autoSave ? 'checked' : ''} onchange="gameData.settings.autoSave = this.checked">
                        è‡ªåŠ¨ä¿å­˜
                    </label>
                </div>
                <div style="margin: 10px 0;">
                    <label>
                        <input type="checkbox" ${settings.soundEnabled ? 'checked' : ''} onchange="gameData.settings.soundEnabled = this.checked">
                        éŸ³æ•ˆå¼€å¯
                    </label>
                </div>
                <div>
                    <label>
                        <input type="checkbox" ${settings.animationsEnabled ? 'checked' : ''} onchange="gameData.settings.animationsEnabled = this.checked">
                        åŠ¨ç”»æ•ˆæœ
                    </label>
                </div>
                <hr style="margin: 20px 0;">
                <div>
                    <h4>å¯¼å‡º/å¯¼å…¥å­˜æ¡£</h4>
                    <button class="btn btn-primary" onclick="exportSave()" style="margin: 5px;">å¯¼å‡ºå­˜æ¡£</button>
                    <button class="btn btn-success" onclick="importSave()" style="margin: 5px;">å¯¼å…¥å­˜æ¡£</button>
                </div>
            `, [
                { text: 'ç¡®å®š', class: 'btn-primary', onclick: 'closeModal()' }
            ]);
        }

        function exportSave() {
            try {
                const saveData = JSON.stringify(gameData, null, 2);
                const blob = new Blob([saveData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `cultivation_save_${new Date().toISOString().slice(0, 10)}.json`;
                a.click();
                URL.revokeObjectURL(url);
                showNotification('å­˜æ¡£å¯¼å‡ºæˆåŠŸï¼', 'success');
            } catch (error) {
                showNotification('å¯¼å‡ºå¤±è´¥ï¼', 'error');
            }
        }

        function importSave() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const importedData = JSON.parse(e.target.result);
                            gameData = importedData;
                            updateAllDisplays();
                            generateMap();
                            showNotification('å­˜æ¡£å¯¼å…¥æˆåŠŸï¼', 'success');
                            closeModal();
                        } catch (error) {
                            showNotification('å¯¼å…¥å¤±è´¥ï¼Œæ–‡ä»¶æ ¼å¼é”™è¯¯ï¼', 'error');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        // å­˜æ¡£ç³»ç»Ÿ
        function saveGame() {
            try {
                localStorage.setItem('cultivationGameSave', JSON.stringify(gameData));
                localStorage.setItem('cultivationGameLastSave', Date.now().toString());
                showNotification('æ¸¸æˆä¿å­˜æˆåŠŸï¼', 'success');
            } catch (error) {
                showNotification('ä¿å­˜å¤±è´¥ï¼', 'error');
            }
        }

        function loadGame() {
            try {
                const saveData = localStorage.getItem('cultivationGameSave');
                if (saveData) {
                    gameData = JSON.parse(saveData);
                    updateAllDisplays();
                    generateMap();
                    showNotification('æ¸¸æˆåŠ è½½æˆåŠŸï¼', 'success');
                    addMessage('ä»å­˜æ¡£ä¸­åŠ è½½æ¸¸æˆ', 'system');
                } else {
                    showNotification('æ²¡æœ‰æ‰¾åˆ°å­˜æ¡£ï¼', 'warning');
                }
            } catch (error) {
                showNotification('åŠ è½½å¤±è´¥ï¼', 'error');
            }
        }

        function resetGame() {
            showModal('é‡ç½®æ¸¸æˆ', 'ç¡®å®šè¦é‡ç½®æ¸¸æˆå—ï¼Ÿè¿™å°†æ¸…é™¤æ‰€æœ‰è¿›åº¦ï¼', [
                { text: 'ç¡®å®šé‡ç½®', class: 'btn-danger', onclick: 'confirmReset()' },
                { text: 'å–æ¶ˆ', class: 'btn-primary', onclick: 'closeModal()' }
            ]);
        }

        function confirmReset() {
            localStorage.removeItem('cultivationGameSave');
            localStorage.removeItem('cultivationGameLastSave');
            location.reload();
        }

        // åˆå§‹åŒ–æ¸¸æˆ
        window.onload = function() {
            // å°è¯•åŠ è½½å­˜æ¡£
            const saveData = localStorage.getItem('cultivationGameSave');
            if (saveData) {
                try {
                    gameData = JSON.parse(saveData);
                    addMessage('ä»å­˜æ¡£ä¸­åŠ è½½æ¸¸æˆ', 'system');
                } catch (error) {
                    console.log('å­˜æ¡£æŸåï¼Œä½¿ç”¨é»˜è®¤æ•°æ®');
                    addMessage('å­˜æ¡£æŸåï¼Œé‡æ–°å¼€å§‹æ¸¸æˆ', 'system');
                }
            }
            
            initGame();
            
            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
            document.getElementById('modal-overlay').onclick = function(e) {
                if (e.target === this) {
                    closeModal();
                }
            };
        };

        // é”®ç›˜å¿«æ·é”®
        document.addEventListener('keydown', function(e) {
            if (e.target.tagName === 'INPUT') return; // å¿½ç•¥è¾“å…¥æ¡†
            
            switch(e.key) {
                case 'c':
                case 'C':
                    cultivate();
                    break;
                case 'a':
                case 'A':
                    adventure();
                    break;
                case 'b':
                case 'B':
                    if (!gameData.battle.inBattle) {
                        randomBattle();
                    }
                    break;
                case 's':
                case 'S':
                    if (e.ctrlKey) {
                        e.preventDefault();
                        saveGame();
                    }
                    break;
                case 'Escape':
                    closeModal();
                    break;
                case ' ':
                    e.preventDefault();
                    if (gameData.battle.inBattle && gameData.battle.playerTurn) {
                        normalAttack();
                    }
                    break;
            }
        });

        // å®šæœŸè‡ªåŠ¨ä¿å­˜
        setInterval(() => {
            if (gameData.settings.autoSave) {
                saveGame();
            }
        }, 300000); // æ¯5åˆ†é’Ÿè‡ªåŠ¨ä¿å­˜

        // é¡µé¢å…³é—­å‰ä¿å­˜
        window.addEventListener('beforeunload', function() {
            if (gameData.settings.autoSave) {
                localStorage.setItem('cultivationGameSave', JSON.stringify(gameData));
                localStorage.setItem('cultivationGameLastSave', Date.now().toString());
            }
        });

        // é¡µé¢å¯è§æ€§å˜åŒ–å¤„ç†ï¼ˆç”¨äºç¦»çº¿æ”¶ç›Šè®¡ç®—ï¼‰
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                // é¡µé¢éšè—æ—¶è®°å½•æ—¶é—´
                localStorage.setItem('cultivationGameLastActive', Date.now().toString());
            } else {
                // é¡µé¢é‡æ–°å¯è§æ—¶æ£€æŸ¥ç¦»çº¿æ”¶ç›Š
                checkOfflineProgress();
            }
        });
    </script>
</body>
</html>